<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neote Plus IDE Simulator 2</title>
    <link rel='manifest' href='manifest.json'>
    <link rel="icon" href="./neote logo.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap');

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-code: #161616;
            --text-main: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-dim: #707070;
            --highlight-purple: #9333ea;
            --highlight-purple-light: #a855f7;
            --highlight-purple-dark: #7c3aed;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --border-color: #333333;
            --hover-bg: #2a2a2a;
            --active-bg: #3a3a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Custom Bootstrap Overrides */
        .btn-primary {
            background-color: var(--highlight-purple) !important;
            border-color: var(--highlight-purple) !important;
            color: white !important;
            font-weight: 500 !important;
        }

        .btn-primary:hover {
            background-color: var(--highlight-purple-dark) !important;
            border-color: var(--highlight-purple-dark) !important;
        }

        .btn-secondary {
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
            color: var(--text-main) !important;
        }

        .btn-secondary:hover {
            background-color: var(--hover-bg) !important;
            border-color: var(--border-color) !important;
        }

        .btn-success {
            background-color: var(--accent-green) !important;
            border-color: var(--accent-green) !important;
        }

        .btn-danger {
            background-color: var(--accent-red) !important;
            border-color: var(--accent-red) !important;
        }

        .btn-warning {
            background-color: var(--accent-yellow) !important;
            border-color: var(--accent-yellow) !important;
        }

        .modal-content {
            background-color: var(--bg-secondary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
        }

        .modal-header {
            background-color: var(--bg-tertiary) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .modal-footer {
            background-color: var(--bg-tertiary) !important;
            border-top: 1px solid var(--border-color) !important;
        }

        .form-control {
            background-color: var(--bg-tertiary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
        }

        .form-control:focus {
            background-color: var(--bg-tertiary) !important;
            border-color: var(--highlight-purple) !important;
            color: var(--text-main) !important;
            box-shadow: 0 0 0 0.25rem rgba(147, 51, 234, 0.25) !important;
        }

        .nav-tabs .nav-link {
            color: var(--text-secondary) !important;
            border-bottom: 2px solid transparent !important;
        }

        .nav-tabs .nav-link.active {
            color: var(--highlight-purple-light) !important;
            border-bottom: 2px solid var(--highlight-purple-light) !important;
            font-weight: 600 !important;
            background-color: transparent !important;
        }

        .nav-tabs .nav-link:hover {
            color: var(--text-main) !important;
            border-bottom: 2px solid var(--highlight-purple) !important;
        }

        /* Custom Components */
        .sidebar {
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            width: 220px;
            padding: 12px;
            overflow-y: auto;
        }

        .editor-line-style {
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding-top: 12px;
            padding-bottom: 12px;
            tab-size: 4;
            color: var(--text-main);
        }

        #neote-editor {
            flex-grow: 1;
            height: 100%;
            background-color: var(--bg-code);
            color: var(--text-main);
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            border: none;
            outline: none;
            resize: none;
            padding: 16px;
            tab-size: 4;
            white-space: pre;
            overflow: auto;
        }

        #line-numbers {
            width: 45px;
            text-align: right;
            padding-right: 10px;
            color: var(--text-dim);
            background-color: var(--bg-tertiary);
            overflow: hidden;
            white-space: pre;
            user-select: none;
            flex-shrink: 0;
        }

        .neote-button {
            padding: 8px 16px;
            margin: 8px 0;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            background-color: var(--highlight-purple);
            color: white;
            border: 1px solid var(--highlight-purple-dark);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .neote-button:hover {
            background-color: var(--highlight-purple-dark);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        .showcase-output {
            background-color: transparent;
            padding: 8px 0;
            border-radius: 0;
            color: var(--text-main);
            word-break: break-all;
            white-space: pre-wrap;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .showcase-error {
            background-color: rgba(239, 68, 68, 0.1);
            padding: 12px 16px;
            border-radius: 6px;
            color: var(--accent-red);
            border-left: 4px solid var(--accent-red);
            margin: 8px 0;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
            padding: 24px;
            border-radius: 12px;
        }

        .modal-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.15s;
            background-color: var(--bg-tertiary);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .modal-button:hover {
            background-color: var(--hover-bg);
            transform: translateY(-1px);
        }

        .modal-button-primary {
            background-color: var(--highlight-purple);
            border-color: var(--highlight-purple-dark);
        }

        .modal-button-primary:hover {
            background-color: var(--highlight-purple-dark);
        }

        .input-field {
            background-color: var(--bg-tertiary);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
        }

        .panel-tab {
            padding-bottom: 6px;
            transition: color 0.1s, border-bottom-width 0.1s;
            cursor: pointer;
            font-weight: 500;
        }

        .panel-tab.active {
            color: var(--highlight-purple-light);
            border-bottom: 2px solid var(--highlight-purple-light);
            font-weight: 600;
        }

        /* File Tab Styles */
        .file-tab {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px 6px 0 0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            margin-right: 4px;
        }

        .file-tab:hover {
            background-color: var(--hover-bg);
        }

        .file-tab.active {
            background-color: var(--bg-primary);
            border-bottom-color: var(--bg-primary);
            color: var(--text-main);
        }

        .file-tab .close-btn {
            margin-left: 8px;
            padding: 2px;
            border-radius: 2px;
            opacity: 0.7;
            transition: opacity 0.15s;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
        }

        .file-tab .close-btn:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .file-tab.unsaved {
            font-style: italic;
        }

        .file-tab.unsaved::after {
            content: '‚Ä¢';
            margin-left: 4px;
            color: var(--accent-yellow);
        }

        /* File Explorer Styles */
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            position: relative;
            transition: background-color 0.15s;
        }

        .file-item:hover {
            background-color: var(--hover-bg);
        }

        .file-item.active {
            background-color: var(--hover-bg);
        }

        .file-actions {
            display: none;
            position: absolute;
            right: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .file-item:hover .file-actions {
            display: flex;
        }

        .file-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 3px;
            transition: all 0.15s;
        }

        .file-action-btn:hover {
            background-color: var(--active-bg);
            color: var(--text-main);
        }

        /* Layout */
        header {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            padding: 6px 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #ide-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .file-tabs-container {
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 8px 12px;
            overflow-x: auto;
        }

        #file-tabs {
            display: flex;
            flex: 1;
        }

        .file-controls {
            display: flex;
            margin-left: 16px;
        }

        .file-controls button {
            font-size: 13px;
            padding: 6px 10px;
            margin-left: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .btn-new {
            background-color: var(--highlight-purple);
            color: white;
        }

        .btn-new:hover {
            background-color: var(--highlight-purple-dark);
        }

        .btn-save {
            background-color: var(--accent-green);
            color: white;
        }

        .btn-save:hover {
            background-color: #059669;
        }

        .btn-open {
            background-color: var(--accent-blue);
            color: white;
        }

        .btn-open:hover {
            background-color: #2563eb;
        }

        #editor-pane {
            position: relative;
            overflow: hidden;
            height: 65%;
            background-color: var(--bg-code);
        }

        #editor-pane>div {
            position: absolute;
            inset: 0;
            display: flex;
        }

        #resize-handle {
            height: 6px;
            background-color: var(--bg-tertiary);
            cursor: row-resize;
            transition: background-color 0.2s;
            flex-shrink: 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        #resize-handle:hover {
            background-color: var(--highlight-purple);
        }

        #panel-pane {
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 35%;
            background-color: var(--bg-secondary);
        }

        .panel-header {
            background-color: var(--bg-tertiary);
            padding: 8px 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-tabs {
            display: flex;
        }

        .panel-tabs>span {
            margin-right: 20px;
            font-weight: 500;
        }

        .run-button {
            background-color: var(--accent-green) !important;
            padding: 6px 16px !important;
            margin: 0 !important;
            border-radius: 6px !important;
            box-shadow: none !important;
            font-weight: 500 !important;
        }

        .run-button:hover {
            background-color: #059669 !important;
        }

        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .panel-content>div {
            position: absolute;
            inset: 0;
        }

        .output-content {
            background-color: var(--bg-code);
            padding: 16px;
            font-size: 13px;
            overflow-y: auto;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
        }

        .hidden {
            display: none !important;
        }

        .text-green-400 {
            color: var(--accent-green);
        }

        .text-red-400 {
            color: var(--accent-red);
        }

        .text-yellow-300 {
            color: var(--accent-yellow);
        }

        .text-purple-400 {
            color: var(--highlight-purple-light);
        }

        .text-gray-400 {
            color: var(--text-secondary);
        }

        .text-gray-300 {
            color: var(--text-main);
        }

        .text-white {
            color: white;
        }

        .font-mono {
            font-family: 'Fira Code', monospace;
        }

        .font-bold {
            font-weight: 600;
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .space-y-4>*+* {
            margin-top: 16px;
        }

        .space-x-3>*+* {
            margin-left: 12px;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1;
        }

        .items-center {
            align-items: center;
        }

        .justify-end {
            justify-content: flex-end;
        }

        .w-full {
            width: 100%;
        }

        .w-3 {
            width: 12px;
        }

        .w-4 {
            width: 16px;
        }

        .h-3 {
            height: 12px;
        }

        .h-4 {
            height: 16px;
        }

        .p-2 {
            padding: 8px;
        }

        .p-4 {
            padding: 16px;
        }

        .p-6 {
            padding: 24px;
        }

        .px-2 {
            padding-left: 8px;
            padding-right: 8px;
        }

        .py-1 {
            padding-top: 4px;
            padding-bottom: 4px;
        }

        .pl-4 {
            padding-left: 16px;
        }

        .ml-2 {
            margin-left: 8px;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .my-2 {
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .rounded {
            border-radius: 4px;
        }

        .rounded-md {
            border-radius: 6px;
        }

        .rounded-lg {
            border-radius: 8px;
        }

        .border {
            border: 1px solid var(--border-color);
        }

        .border-t {
            border-top: 1px solid var(--border-color);
        }

        .border-gray-700 {
            border-color: var(--border-color);
        }

        .bg-black {
            background-color: var(--bg-primary);
        }

        .bg-transparent {
            background: transparent;
        }

        .outline-none {
            outline: none;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .select-none {
            user-select: none;
        }

        .overflow-y-auto {
            overflow-y: auto;
        }

        .overflow-x-auto {
            overflow-x: auto;
        }

        .overflow-hidden {
            overflow: hidden;
        }

        .text-xs {
            font-size: 12px;
        }

        .text-sm {
            font-size: 14px;
        }

        .text-lg {
            font-size: 18px;
        }

        .font-semibold {
            font-weight: 600;
        }

        .uppercase {
            text-transform: uppercase;
        }

        .tracking-wider {
            letter-spacing: 0.05em;
        }

        .autocomplete-dropdown {
            position: absolute;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-main);
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            transition: background-color 0.15s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--highlight-purple);
        }

        .autocomplete-item .keyword {
            color: var(--highlight-purple-light);
            font-weight: 600;
        }

        .autocomplete-item .desc {
            color: var(--text-secondary);
            font-size: 11px;
            margin-left: 8px;
        }

        /* Home Page Styles */
        .home-container {
            flex: 1;
            overflow-y: auto;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
        }

        .home-header {
            background: linear-gradient(90deg, var(--highlight-purple), var(--highlight-purple-light));
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        .home-header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
            color: white;
            letter-spacing: -1px;
        }

        .home-header p {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .home-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 60px;
        }

        .home-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 28px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .home-card:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--highlight-purple);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(147, 51, 234, 0.15);
        }

        .home-card-icon {
            font-size: 32px;
            margin-bottom: 16px;
            display: block;
        }

        .home-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: white;
        }

        .home-card p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }

        .home-section {
            margin-bottom: 48px;
        }

        .home-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--highlight-purple);
            display: inline-block;
        }

        .home-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .home-feature-item {
            background-color: var(--bg-secondary);
            padding: 16px;
            border-left: 4px solid var(--highlight-purple);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .home-feature-item strong {
            color: var(--highlight-purple-light);
            display: block;
            margin-bottom: 6px;
        }

        .home-feature-item span {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .home-buttons {
            display: flex;
            gap: 16px;
            margin-bottom: 48px;
            flex-wrap: wrap;
        }

        .home-btn {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .home-btn-primary {
            background-color: var(--highlight-purple);
            color: white;
        }

        .home-btn-primary:hover {
            background-color: var(--highlight-purple-dark);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
            transform: translateY(-2px);
        }

        .home-btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .home-btn-secondary:hover {
            background-color: var(--hover-bg);
            border-color: var(--highlight-purple);
            transform: translateY(-2px);
        }

        .home-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 48px;
        }

        .home-stat {
            text-align: center;
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .home-stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--highlight-purple-light);
            margin-bottom: 8px;
        }

        .home-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .home-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 32px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .home-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .home-features {
                grid-template-columns: 1fr;
            }

            .home-header h1 {
                font-size: 32px;
            }

            .home-content {
                padding: 30px 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Top Bar -->
    <header>
        <span class="d-none d-md-inline">File | Edit | Selection | View | Go | Run | Terminal | Help</span>
        <span class="font-semibold" id="header-title">Neote IDE - Home</span>
        <span><i class="bi bi-circle-fill text-danger"></i> <i class="bi bi-circle-fill text-warning"></i> <i
                class="bi bi-circle-fill text-success"></i></span>
    </header>

    <!-- Home Page -->
    <div id="home-page" class="home-container">
        <div class="home-header">
            <h1>‚ú® Neote Plus IDE</h1>
            <h2>By warren adrian</h2>
            <p>A modern, extensible code editor with built-in extensions system</p>
        </div>

        <div class="home-content">
            <div class="home-buttons">
                <button class="home-btn home-btn-primary" onclick="startNewFile()">
                    <i class="bi bi-file-earmark-code me-2"></i> New File
                </button>
                <button class="home-btn home-btn-secondary" onclick="showIDE()">
                    <i class="bi bi-lightning-charge me-2"></i> Go to IDE
                </button>
            </div>

            <div class="home-section">
                <h2>üìä Quick Stats</h2>
                <div class="home-stats">
                    <div class="home-stat">
                        <div class="home-stat-number">5+</div>
                        <div class="home-stat-label">Built-in Extensions</div>
                    </div>
                    <div class="home-stat">
                        <div class="home-stat-number">50+</div>
                        <div class="home-stat-label">Language Features</div>
                    </div>
                    <div class="home-stat">
                        <div class="home-stat-number">‚àû</div>
                        <div class="home-stat-label">Extensible</div>
                    </div>
                    <div class="home-stat">
                        <div class="home-stat-number">‚ö°</div>
                        <div class="home-stat-label">Fast & Lightweight</div>
                    </div>
                </div>
            </div>

            <div class="home-section">
                <h2>üöÄ Key Features</h2>
                <div class="home-grid">
                    <div class="home-card" onclick="showIDE()">
                        <span class="home-card-icon">üìù</span>
                        <h3>Code Editor</h3>
                        <p>Full-featured editor with syntax highlighting, line numbers, and smart autocomplete.</p>
                    </div>
                    <div class="home-card" onclick="showIDE()">
                        <span class="home-card-icon">üß©</span>
                        <h3>Extension System</h3>
                        <p>Create and manage custom extensions right from the IDE. Build powerful tools in Neote.</p>
                    </div>
                    <div class="home-card" onclick="showIDE()">
                        <span class="home-card-icon">üìä</span>
                        <h3>Charts & Graphs</h3>
                        <p>Visualize data with built-in chart support. Create bar, line, pie, and more charts.</p>
                    </div>
                    <div class="home-card" onclick="showIDE()">
                        <span class="home-card-icon">üóÇÔ∏è</span>
                        <h3>File Management</h3>
                        <p>Organize your projects with intuitive file explorer and tab-based editing.</p>
                    </div>
                    <div class="home-card" onclick="showIDE()">
                        <span class="home-card-icon">üé®</span>
                        <h3>Styling System</h3>
                        <p>Apply CSS styles to your output with an intuitive syntax. Style text, colors, and layouts.
                        </p>
                    </div>
                    <div class="home-card" onclick="showIDE()">
                        <span class="home-card-icon">‚öôÔ∏è</span>
                        <h3>Math & Logic</h3>
                        <p>Complete math module with functions, loops, conditionals, and data structures.</p>
                    </div>
                </div>
            </div>

            <div class="home-section">
                <h2>üí° Quick Start</h2>
                <div class="home-features">
                    <div class="home-feature-item">
                        <strong>1. Create Files</strong>
                        <span>Click "New File" to start a new Neote project. Files are saved in your browser.</span>
                    </div>
                    <div class="home-feature-item">
                        <strong>2. Write Code</strong>
                        <span>Use Neote's intuitive syntax to write interactive applications with autocomplete
                            help.</span>
                    </div>
                    <div class="home-feature-item">
                        <strong>3. Run & Debug</strong>
                        <span>Execute code instantly with the Run button. See output, errors, and debug info
                            live.</span>
                    </div>
                    <div class="home-feature-item">
                        <strong>4. Extend Features</strong>
                        <span>Create extensions to add new functionality. Share and reuse them across projects.</span>
                    </div>
                </div>
            </div>

            <div class="home-section">
                <h2>üìö Popular Commands</h2>
                <div class="home-features">
                    <div class="home-feature-item">
                        <strong>showcase()</strong>
                        <span>Display output to the panel. Use $variable for interpolation.</span>
                    </div>
                    <div class="home-feature-item">
                        <strong>st variable = value</strong>
                        <span>Declare variables. Supports strings, numbers, arrays, and objects.</span>
                    </div>
                    <div class="home-feature-item">
                        <strong>button() input()</strong>
                        <span>Create interactive UI elements. Build forms and user interfaces.</span>
                    </div>
                    <div class="home-feature-item">
                        <strong>ext.execute()</strong>
                        <span>Run extensions. Execute custom functionality built into the IDE.</span>
                    </div>
                </div>
            </div>

            <div class="home-footer">
                <p>üíª Neote Plus IDE v4.1.8 | Built for developers who love simplicity and power | <a href="#"
                        style="color: var(--highlight-purple-light); text-decoration: none;">View Documentation</a></p>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="ide-main" style="display: none;">
        <!-- Sidebar/Explorer -->
        <div class="sidebar">
            <h3 class="text-xs font-semibold mb-3 uppercase tracking-wider text-secondary">Explorer</h3>
            <div id="file-explorer"></div>

            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">

            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 class="text-xs font-semibold uppercase tracking-wider text-secondary">Extensions</h3>
                <button onclick="openCreateExtensionModal()"
                    style="background: none; border: none; color: var(--highlight-purple-light); cursor: pointer; font-size: 16px; padding: 0;"
                    title="Create Extension">
                    <i class="bi bi-plus-circle"></i>
                </button>
            </div>
            <div id="extensions-list" style="font-size: 13px;"></div>
        </div>

        <!-- Editor and Panel -->
        <div id="ide-container">
            <!-- File Tabs -->
            <div class="file-tabs-container">
                <div id="file-tabs"></div>
                <div class="file-controls">
                    <button onclick="createNewFile()" class="btn-new" title="New File">
                        <i class="bi bi-file-earmark-plus"></i>
                    </button>
                    <button onclick="saveCurrentFile()" class="btn-save" title="Save File">
                        <i class="bi bi-save"></i>
                    </button>
                    <button onclick="openFileDialog()" class="btn-open" title="Open File">
                        <i class="bi bi-folder-open"></i>
                    </button>
                </div>
            </div>

            <!-- Editor Area -->
            <div id="editor-pane">
                <div>
                    <div id="line-numbers" class="editor-line-style"></div>
                    <textarea id="neote-editor" class="editor-line-style">$attach, @neote;
 $attach, @neoteMath take *;
 $attach, @neoteChart take *;

// Math Module Demo
showcase("=== Math Module Demo ===")
st randomNum = random(1, 100)
st rounded = round(randomNum)
st sqrtVal = sqrt(16)
st powerVal = pow(2, 8)
st piVal = pi()

showcase("Random: $randomNum")
showcase("Rounded: $rounded")
showcase("Square root of 16: $sqrtVal")
showcase("2^8 = $powerVal")
showcase("Pi = $piVal")

divider("Chart Module Demo")

// Chart Module Demo
st salesData = [65, 59, 80, 81, 56, 55, 40]
st months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"]

chart.bar(salesData, months, "Monthly Sales")
chart.line(salesData, months, "Sales Trend")

st pieData = [300, 50, 100]
st pieLabels = ["Red", "Blue", "Yellow"]
chart.pie(pieData, pieLabels, "Color Distribution")

showcase("Charts rendered successfully!")
</textarea>
                </div>
            </div>

            <!-- Resize Handle -->
            <div id="resize-handle"></div>

            <!-- Panel -->
            <div id="panel-pane">
                <div class="panel-header">
                    <div class="panel-tabs">
                        <span id="tab-output" onclick="showPanel('output')" class="panel-tab active">OUTPUT</span>
                        <span id="tab-terminal" onclick="showPanel('terminal')"
                            class="panel-tab text-secondary">TERMINAL</span>
                        <span id="tab-problems" onclick="showPanel('problems')"
                            class="panel-tab text-secondary">PROBLEMS</span>
                        <span id="variableViewer" class="text-xs text-warning font-mono ps-4">Variables: Ready.</span>
                    </div>
                    <button onclick="runNeoteCode()" class="neote-button run-button">
                        <i class="bi bi-play-fill me-1"></i>
                        <span>Run Code</span>
                    </button>
                </div>
                <div class="panel-content">
                    <div id="panel-output" class="output-content">
                        <div class="text-white">Run the code to see the application's final output (showcase, buttons,
                            media).</div>
                    </div>

                    <div id="panel-terminal" class="bg-black flex flex-col hidden">
                        <div id="terminal-history" class="p-2 text-xs overflow-y-auto flex-1 font-mono text-secondary">
                            <div class="text-success">Neote Plus Interpreter Ready. Use 'neote bash' for system commands
                                or '#teach -all' to learn tags.</div>
                        </div>
                        <div class="d-flex align-items-center p-2 border-top border-secondary"
                            style="background-color: var(--bg-tertiary); font-size: 13px;">
                            <span id="terminal-prompt" class="text-purple-400 font-bold me-2">$></span>
                            <input type="text" id="terminal-input"
                                class="bg-transparent text-white flex-1 border-0 outline-none"
                                onkeydown="checkTerminalCommand(event)">
                        </div>
                    </div>

                    <div id="panel-problems" class="output-content hidden">
                        <div class="text-white">All errors, warnings, and problems will be listed here.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="neote-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-3">Title</h3>
            <p id="modal-message" class="text-secondary mb-3">Message</p>
            <input type="text" id="modal-input" class="input-field w-full p-2 rounded-md hidden mb-3"
                placeholder="Type your answer...">
            <div class="d-flex justify-end gap-2">
                <button id="modal-ok" class="modal-button modal-button-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Extension Creation Modal -->
    <div id="extension-modal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="extension-modal-title" class="text-lg font-bold text-white mb-3">Create Extension</h3>
            <div class="mb-3">
                <label class="text-secondary text-sm">Extension Name</label>
                <input type="text" id="extension-name" class="input-field w-full p-2 rounded-md"
                    placeholder="e.g., TextTransform">
            </div>
            <div class="mb-3">
                <label class="text-secondary text-sm">Description</label>
                <input type="text" id="extension-desc" class="input-field w-full p-2 rounded-md"
                    placeholder="What does this extension do?">
            </div>
            <div class="mb-3">
                <label class="text-secondary text-sm">Extension Code (Neote)</label>
                <textarea id="extension-code" class="input-field w-full p-2 rounded-md"
                    style="height: 200px; font-family: 'Fira Code', monospace; font-size: 13px; resize: vertical;"
                    placeholder="Write your extension code in Neote..."></textarea>
            </div>
            <div class="d-flex justify-end gap-2">
                <button id="extension-cancel" class="modal-button">Cancel</button>
                <button id="extension-save" class="modal-button modal-button-primary">Create Extension</button>
            </div>
        </div>
    </div>

    <!-- Extension View Modal -->
    <div id="extension-view-modal" class="modal-backdrop hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="extension-view-title" class="text-lg font-bold text-white mb-3">Extension Details</h3>
            <div class="mb-3">
                <label class="text-secondary text-sm">Name</label>
                <input type="text" id="extension-view-name" class="input-field w-full p-2 rounded-md" disabled>
            </div>
            <div class="mb-3">
                <label class="text-secondary text-sm">Description</label>
                <input type="text" id="extension-view-desc" class="input-field w-full p-2 rounded-md" disabled>
            </div>
            <div class="mb-3">
                <label class="text-secondary text-sm">Code</label>
                <textarea id="extension-view-code" class="input-field w-full p-2 rounded-md"
                    style="height: 200px; font-family: 'Fira Code', monospace; font-size: 13px; resize: vertical;"
                    disabled></textarea>
            </div>
            <div class="d-flex justify-end gap-2">
                <button id="extension-view-delete" class="modal-button"
                    style="background-color: var(--accent-red);">Delete</button>
                <button id="extension-view-close" class="modal-button">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & UTILITIES ---
        const NEOTE_VERSION = "4.1.8";
        let neoteVariables = {};
        let neoteFunctions = {};
        let neoteMacros = {};
        let modalResolver = null;
        const apiKey = "";

        // File Management System
        let openFiles = {};
        let currentFile = 'app.neote';
        let fileCounter = 1;

        // Initialize default file
        openFiles[currentFile] = {
            content: `$attach, @neote;
 $attach, @neoteMath take *;
 $attach, @neoteChart take *;

// Math Module Demo
showcase("=== Math Module Demo ===")
st randomNum = random(1, 100)
st rounded = round(randomNum)
st sqrtVal = sqrt(16)
st powerVal = pow(2, 8)
st piVal = pi()

showcase("Random: $randomNum")
showcase("Rounded: $rounded")
showcase("Square root of 16: $sqrtVal")
showcase("2^8 = $powerVal")
showcase("Pi = $piVal")

divider("Chart Module Demo")

// Chart Module Demo
st salesData = [65, 59, 80, 81, 56, 55, 40]
st months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"]

chart.bar(salesData, months, "Monthly Sales")
chart.line(salesData, months, "Sales Trend")

st pieData = [300, 50, 100]
st pieLabels = ["Red", "Blue", "Yellow"]
chart.pie(pieData, pieLabels, "Color Distribution")

showcase("Charts rendered successfully!")
`,
            saved: true
        };

        const codeEditor = document.getElementById('neote-editor');
        const outputPanel = document.getElementById('panel-output');
        const problemsPanel = document.getElementById('panel-problems');
        const variableViewer = document.getElementById('variableViewer');
        const modal = document.getElementById('neote-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalOkButton = document.getElementById('modal-ok');
        const lineNumbersElement = document.getElementById('line-numbers');
        const terminalHistory = document.getElementById('terminal-history');
        const editorPane = document.getElementById('editor-pane');
        const panelPane = document.getElementById('panel-pane');
        const resizeHandle = document.getElementById('resize-handle');
        const MIN_PANEL_HEIGHT = 100;

        let isRunningImprop = false;
        let styleCounter = 0;
        let neoteMathEnabled = {};
        let neoteArrayEnabled = {};
        let neoteStorageEnabled = {};
        let neoteTimeEnabled = {};
        let neoteChartEnabled = {};
        let neoteDBEnabled = {};
        let neoteGeoEnabled = {};
        let neoteRegexEnabled = {};
        let neoteFormatEnabled = {};
        let neoteNotifyEnabled = {};
        let neoteDOMEnabled = {};
        let neoteHTTPEnabled = {};
        let chartInstances = {};
        let chartCounter = 0;
        let neoteDB = {};
        let neoteDOMElements = {};
        let neoteClasses = {};

        // --- EXTENSION SYSTEM ---
        let neoteExtensions = {};
        let extensionAPI = {
            register: function (name, description, code) {
                const id = 'ext_' + Date.now();
                neoteExtensions[id] = {
                    id: id,
                    name: name,
                    description: description,
                    code: code,
                    enabled: true,
                    created: new Date().toLocaleString()
                };
                saveExtensions();
                renderExtensionsList();
                return id;
            },
            execute: function (extensionId) {
                if (!neoteExtensions[extensionId]) {
                    displayOutput(`RUNTIME ERROR: Extension '${extensionId}' not found.`, true);
                    return;
                }
                const ext = neoteExtensions[extensionId];
                if (!ext.enabled) {
                    displayOutput(`RUNTIME ERROR: Extension '${ext.name}' is disabled.`, true);
                    return;
                }
                executeLines(ext.code.split('\n').filter(l => l.trim()));
            },
            getVariable: function (varName) {
                return neoteVariables[varName];
            },
            setVariable: function (varName, value) {
                neoteVariables[varName] = value;
                updateVariableViewer();
            },
            listExtensions: function () {
                return Object.values(neoteExtensions).filter(e => e.enabled);
            }
        };

        function saveExtensions() {
            localStorage.setItem('neote_extensions', JSON.stringify(neoteExtensions));
        }

        function loadExtensions() {
            const saved = localStorage.getItem('neote_extensions');
            if (saved) {
                try {
                    neoteExtensions = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load extensions:', e);
                }
            }
        }

        function openCreateExtensionModal() {
            document.getElementById('extension-modal').classList.remove('hidden');
            document.getElementById('extension-name').value = '';
            document.getElementById('extension-desc').value = '';
            document.getElementById('extension-code').value = '';
            document.getElementById('extension-name').focus();
        }

        function closeCreateExtensionModal() {
            document.getElementById('extension-modal').classList.add('hidden');
        }

        function openExtensionViewModal(extensionId) {
            const ext = neoteExtensions[extensionId];
            if (!ext) return;

            document.getElementById('extension-view-modal').classList.remove('hidden');
            document.getElementById('extension-view-name').value = ext.name;
            document.getElementById('extension-view-desc').value = ext.description;
            document.getElementById('extension-view-code').value = ext.code;
            document.getElementById('extension-view-modal').dataset.extensionId = extensionId;
        }

        function closeExtensionViewModal() {
            document.getElementById('extension-view-modal').classList.add('hidden');
        }

        function deleteExtension(extensionId) {
            if (confirm('Are you sure you want to delete this extension?')) {
                delete neoteExtensions[extensionId];
                saveExtensions();
                renderExtensionsList();
                closeExtensionViewModal();
                displayOutput(`Extension deleted successfully.`, false);
            }
        }

        function toggleExtension(extensionId) {
            if (neoteExtensions[extensionId]) {
                neoteExtensions[extensionId].enabled = !neoteExtensions[extensionId].enabled;
                saveExtensions();
                renderExtensionsList();
            }
        }

        function renderExtensionsList() {
            const listContainer = document.getElementById('extensions-list');
            listContainer.innerHTML = '';

            Object.entries(neoteExtensions).forEach(([id, ext]) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 8px; border-radius: 6px; margin-bottom: 6px; background-color: var(--bg-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: space-between;';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = ext.name;
                nameSpan.style.cssText = ext.enabled ? 'color: var(--text-main);' : 'color: var(--text-secondary); text-decoration: line-through;';
                nameSpan.title = ext.description;
                nameSpan.style.flex = '1';
                nameSpan.style.cursor = 'pointer';
                nameSpan.onclick = () => openExtensionViewModal(id);

                const toggleBtn = document.createElement('button');
                toggleBtn.innerHTML = ext.enabled ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>';
                toggleBtn.style.cssText = `background: none; border: none; cursor: pointer; padding: 0 4px; font-size: 14px;`;
                toggleBtn.title = ext.enabled ? 'Disable' : 'Enable';
                toggleBtn.onclick = (e) => { e.stopPropagation(); toggleExtension(id); };

                item.appendChild(nameSpan);
                item.appendChild(toggleBtn);
                listContainer.appendChild(item);
            });

            if (Object.keys(neoteExtensions).length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.textContent = 'No extensions yet.';
                emptyMsg.style.cssText = 'color: var(--text-secondary); font-size: 12px; padding: 8px;';
                listContainer.appendChild(emptyMsg);
            }
        }

        // --- NEOTE TAGS REFERENCE ---
        const NEOTE_TAGS = {
            "st": {
                desc: "Declares and initializes a variable. 'st' stands for 'state'. Supports strings, numbers, arrays, and objects.",
                example: "st data = [1, 2, 3] or st user = {name: 'Alex', age: 25}"
            },
            "showcase": {
                desc: "Outputs text to the application's 'OUTPUT' panel. Supports variable interpolation using the $variable_name format.",
                example: "showcase(\"Value: $data[0]\")"
            },
            "ovr.improp": {
                desc: "Initiates a blocking operation that displays a modal dialog to request user input (like a prompt). Execution pauses until submission.",
                example: "st user_age = ovr.improp(\"How old are you?\")"
            },
            "ovr.cove": {
                desc: "Displays a non-blocking notification modal ('cove') to inform the user about an event.",
                example: "ovr.cove(\"A low-key success notification.\")"
            },
            "button": {
                desc: "Renders an interactive button in the 'OUTPUT' panel. Takes text and a function name.",
                example: "button(\"Click Me\", myFunc)"
            },
            "input": {
                desc: "Creates an input field that assigns its value to a variable when changed.",
                example: "input(\"username\", \"Enter your name\")"
            },
            "call": {
                desc: "Explicitly executes a defined function.",
                example: "call processData"
            },
            "func": {
                desc: "Defines a block of reusable code. Must be defined globally and closed with a '}'.",
                example: "func setup {\n  showcase(\"Setup done.\")\n}"
            },
            "loop": {
                desc: "Executes code a specified number of times. Use $_loopIndex to access current iteration (0-based). Syntax: loop(n) { code }",
                example: "loop(5) { showcase(\"Count: $_loopIndex\") }"
            },
            "each": {
                desc: "Iterates over arrays or objects. Syntax: each array as item { ... } or each object as key value { ... }",
                example: "each colors as color { showcase(\"Color: $color\") }"
            },
            "get.img": {
                desc: "Renders an image in the 'OUTPUT' panel. Requires a URL.",
                example: "get.img(\"https://placehold.co/100x100\")"
            },
            "get.audio": {
                desc: "Renders an audio player in the 'OUTPUT' panel. Requires a URL.",
                example: "get.audio(\"path/to/my.mp3\")"
            },
            "get.video": {
                desc: "Renders a video player in the 'OUTPUT' panel. Requires a URL.",
                example: "get.video(\"path/to/my.mp4\")"
            },
            "style": {
                desc: "Applies CSS-style properties to elements using curly brace syntax.",
                example: "showcase(\"Styled text\") { color: \"red\"; font-size: \"18px\" }"
            },
            "macro": {
                desc: "Defines a reusable code template that expands inline. Syntax: macro name(params) { code }",
                example: "macro greet(name) { showcase(\"Hello $name!\") }"
            },
            "expand": {
                desc: "Expands a macro with given arguments. Syntax: expand macroName(args)",
                example: "expand greet(\"Alice\")"
            },
            "ext.execute": {
                desc: "Executes an installed extension by its ID. Extensions can be created from the Extensions panel in the sidebar.",
                example: "ext.execute(\"ext_1234567890\")"
            },
            "ext.list": {
                desc: "Lists all enabled extensions in the output panel.",
                example: "ext.list()"
            }
        };

        // --- STYLING HELPERS ---
        function parseStyleBlock(styleText) {
            const styles = {};
            const declarations = styleText.split(';').filter(d => d.trim());

            for (const declaration of declarations) {
                const colonIndex = declaration.indexOf(':');
                if (colonIndex === -1) continue;

                const property = declaration.substring(0, colonIndex).trim();
                const value = declaration.substring(colonIndex + 1).trim().replace(/"/g, '');

                if (property && value) {
                    styles[property] = value;
                }
            }

            return styles;
        }

        function applyStylesToElement(element, styles) {
            for (const [property, value] of Object.entries(styles)) {
                const camelProperty = property.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
                element.style[camelProperty] = value;
            }
        }

        function createStyledElement(tagName, content, styles) {
            const element = document.createElement(tagName);
            if (content) {
                if (tagName === 'button') {
                    element.textContent = content;
                } else {
                    element.innerHTML = content;
                }
            }

            if (styles && Object.keys(styles).length > 0) {
                applyStylesToElement(element, styles);
            }

            return element;
        }

        // --- DATA STRUCTURE HELPERS ---
        function createNeoteArray(items = []) {
            return [...items];
        }

        function createNeoteObject(obj = {}) {
            return { ...obj };
        }

        // --- IDE UI FUNCTIONS ---
        function updateLineNumbers(code) {
            const lines = code.split('\n');
            const linesCount = lines.length;
            const numbers = Array.from({ length: linesCount }, (_, i) => i + 1).join('\n');
            lineNumbersElement.textContent = numbers;
        }

        codeEditor.addEventListener('input', function () {
            updateLineNumbers(codeEditor.value);
            if (currentFile && openFiles[currentFile]) {
                openFiles[currentFile].saved = false;
                renderFileTabs();
            }
        });

        function syncScroll() {
            lineNumbersElement.scrollTop = codeEditor.scrollTop;
        }

        codeEditor.addEventListener('scroll', syncScroll);

        let autocompleteDropdown = null;
        let selectedIndex = -1;
        let completions = [];

        const COMPLETIONS = [
            { keyword: 'st', template: 'st varName = "value"', desc: 'declare variable' },
            { keyword: 'showcase', template: 'showcase("$var")', desc: 'output text' },
            { keyword: 'call', template: 'call functionName', desc: 'call function' },
            { keyword: 'func', template: 'func name {\n    \n}', desc: 'define function' },
            { keyword: 'macro', template: 'macro name(param) {\n    \n}', desc: 'define macro' },
            { keyword: 'expand', template: 'expand macroName("arg")', desc: 'expand macro' },
            { keyword: 'button', template: 'button("Text", funcName)', desc: 'create button' },
            { keyword: 'input', template: 'input("varName", "placeholder")', desc: 'create input' },
            { keyword: 'get.img', template: 'get.img("url")', desc: 'load image' },
            { keyword: 'get.audio', template: 'get.audio("url")', desc: 'load audio' },
            { keyword: 'get.video', template: 'get.video("url")', desc: 'load video' },
            { keyword: 'ovr.improp', template: 'st var = ovr.improp("prompt")', desc: 'prompt input' },
            { keyword: 'ovr.cove', template: 'ovr.cove("message")', desc: 'show notification' },
            { keyword: 'loop', template: 'loop(10) { showcase("$_loopIndex") }', desc: 'loop n times' },
            { keyword: 'if', template: 'if(condition) { code } else { code }', desc: 'conditional' },
            // Math Module
            { keyword: 'random', template: 'random(min, max)', desc: 'random number' },
            { keyword: 'round', template: 'round(num)', desc: 'round number' },
            { keyword: 'floor', template: 'floor(num)', desc: 'floor number' },
            { keyword: 'ceil', template: 'ceil(num)', desc: 'ceiling number' },
            { keyword: 'abs', template: 'abs(num)', desc: 'absolute value' },
            { keyword: 'sqrt', template: 'sqrt(num)', desc: 'square root' },
            { keyword: 'pow', template: 'pow(base, exp)', desc: 'power' },
            { keyword: 'sin', template: 'sin(num)', desc: 'sine' },
            { keyword: 'cos', template: 'cos(num)', desc: 'cosine' },
            { keyword: 'tan', template: 'tan(num)', desc: 'tangent' },
            { keyword: 'min', template: 'min(a, b, c)', desc: 'minimum value' },
            { keyword: 'max', template: 'max(a, b, c)', desc: 'maximum value' },
            { keyword: 'log', template: 'log(num)', desc: 'natural log' },
            { keyword: 'exp', template: 'exp(num)', desc: 'e^x' },
            { keyword: 'pi', template: 'pi()', desc: 'pi constant' },
            { keyword: 'e', template: 'e()', desc: 'euler constant' },
            // Chart Module
            { keyword: 'chart.bar', template: 'chart.bar([10, 20, 30], ["A", "B", "C"], "Title")', desc: 'bar chart' },
            { keyword: 'chart.line', template: 'chart.line([10, 20, 30], ["A", "B", "C"], "Title")', desc: 'line chart' },
            { keyword: 'chart.pie', template: 'chart.pie([10, 20, 30], ["A", "B", "C"], "Title")', desc: 'pie chart' },
            { keyword: 'chart.doughnut', template: 'chart.doughnut([10, 20, 30], ["A", "B", "C"], "Title")', desc: 'doughnut chart' },
            { keyword: 'chart.radar', template: 'chart.radar([10, 20, 30], ["A", "B", "C"], "Title")', desc: 'radar chart' },
            { keyword: 'chart.polarArea', template: 'chart.polarArea([10, 20, 30], ["A", "B", "C"], "Title")', desc: 'polar area chart' },
            // DB Module
            { keyword: 'db.create', template: 'db.create("tableName")', desc: 'create table' },
            { keyword: 'db.insert', template: 'db.insert("table", {id: 1, name: "John"})', desc: 'insert record' },
            { keyword: 'db.get', template: 'db.get("table", id)', desc: 'get record by id' },
            { keyword: 'db.getAll', template: 'db.getAll("table")', desc: 'get all records' },
            { keyword: 'db.update', template: 'db.update("table", id, {name: "Jane"})', desc: 'update record' },
            { keyword: 'db.delete', template: 'db.delete("table", id)', desc: 'delete record' },
            { keyword: 'db.query', template: 'db.query("table", "name", "John")', desc: 'query records' },
            { keyword: 'db.drop', template: 'db.drop("table")', desc: 'drop table' },
            // Geo Module
            { keyword: 'geo.distance', template: 'geo.distance(lat1, lon1, lat2, lon2)', desc: 'calculate distance' },
            { keyword: 'geo.getLocation', template: 'geo.getLocation()', desc: 'get current location' },
            { keyword: 'geo.geocode', template: 'geo.geocode("address")', desc: 'address to coords' },
            // Regex Module
            { keyword: 'regex.match', template: 'regex.match("text", "pattern")', desc: 'match pattern' },
            { keyword: 'regex.test', template: 'regex.test("text", "pattern")', desc: 'test pattern' },
            { keyword: 'regex.replace', template: 'regex.replace("text", "pattern", "replacement")', desc: 'replace pattern' },
            { keyword: 'regex.split', template: 'regex.split("text", "pattern")', desc: 'split by pattern' },
            { keyword: 'regex.extract', template: 'regex.extract("text", "pattern")', desc: 'extract matches' },
            // Format Module
            { keyword: 'format.currency', template: 'format.currency(1234.56, "USD")', desc: 'format currency' },
            { keyword: 'format.number', template: 'format.number(1234.567, 2)', desc: 'format number' },
            { keyword: 'format.date', template: 'format.date(timestamp, "YYYY-MM-DD")', desc: 'format date' },
            { keyword: 'format.fileSize', template: 'format.fileSize(1024)', desc: 'format file size' },
            { keyword: 'format.percentage', template: 'format.percentage(0.75)', desc: 'format percentage' },
            { keyword: 'format.capitalize', template: 'format.capitalize("hello world")', desc: 'capitalize text' },
            // Notify Module
            { keyword: 'notify.success', template: 'notify.success("message")', desc: 'success notification' },
            { keyword: 'notify.error', template: 'notify.error("message")', desc: 'error notification' },
            { keyword: 'notify.warning', template: 'notify.warning("message")', desc: 'warning notification' },
            { keyword: 'notify.info', template: 'notify.info("message")', desc: 'info notification' },
            // DOM Module
            { keyword: 'dom.create', template: 'dom.create("div", "elementId")', desc: 'create element' },
            { keyword: 'dom.setText', template: 'dom.setText("elementId", "text")', desc: 'set text content' },
            { keyword: 'dom.setHTML', template: 'dom.setHTML("elementId", "<b>html</b>")', desc: 'set HTML content' },
            { keyword: 'dom.setStyle', template: 'dom.setStyle("elementId", "color", "red")', desc: 'set style property' },
            { keyword: 'dom.addClass', template: 'dom.addClass("elementId", "className")', desc: 'add CSS class' },
            { keyword: 'dom.removeClass', template: 'dom.removeClass("elementId", "className")', desc: 'remove CSS class' },
            { keyword: 'dom.remove', template: 'dom.remove("elementId")', desc: 'remove element' },
            { keyword: 'dom.show', template: 'dom.show("elementId")', desc: 'show element' },
            { keyword: 'dom.hide', template: 'dom.hide("elementId")', desc: 'hide element' },
            // HTTP Module
            { keyword: 'http.get', template: 'http.get("url")', desc: 'GET request' },
            { keyword: 'http.post', template: 'http.post("url", {data: "value"})', desc: 'POST request' },
            { keyword: 'http.put', template: 'http.put("url", {data: "value"})', desc: 'PUT request' },
            { keyword: 'http.delete', template: 'http.delete("url")', desc: 'DELETE request' },
            // Array Module
            { keyword: 'push', template: 'push(array, value)', desc: 'add to array' },
            { keyword: 'pop', template: 'pop(array)', desc: 'remove last' },
            { keyword: 'shift', template: 'shift(array)', desc: 'remove first' },
            { keyword: 'unshift', template: 'unshift(array, value)', desc: 'add to start' },
            { keyword: 'length', template: 'length(array)', desc: 'array length' },
            { keyword: 'join', template: 'join(array, ", ")', desc: 'join array' },
            { keyword: 'reverse', template: 'reverse(array)', desc: 'reverse array' },
            { keyword: 'sort', template: 'sort(array)', desc: 'sort array' },
            { keyword: 'includes', template: 'includes(array, value)', desc: 'check if includes' },
            { keyword: 'indexOf', template: 'indexOf(array, value)', desc: 'find index' },
            { keyword: 'slice', template: 'slice(array, start, end)', desc: 'slice array' },
            // Storage Module
            { keyword: 'save', template: 'save("key", value)', desc: 'save to storage' },
            { keyword: 'load', template: 'load("key")', desc: 'load from storage' },
            { keyword: 'remove', template: 'remove("key")', desc: 'remove from storage' },
            { keyword: 'clearAll', template: 'clearAll()', desc: 'clear all storage' },
            { keyword: 'has', template: 'has("key")', desc: 'check if exists' },
            { keyword: 'keys', template: 'keys()', desc: 'get all keys' },
            // UI Elements
            { keyword: 'checkbox', template: 'checkbox("varName", "label")', desc: 'checkbox input' },
            { keyword: 'select', template: 'select("varName", ["opt1", "opt2"])', desc: 'dropdown select' },
            { keyword: 'slider', template: 'slider("varName", 0, 100)', desc: 'range slider' },
            { keyword: 'textarea', template: 'textarea("varName", "placeholder")', desc: 'text area' },
            { keyword: 'progress', template: 'progress(value, max)', desc: 'progress bar' },
            { keyword: 'divider', template: 'divider("label")', desc: 'divider line' },
            { keyword: 'heading', template: 'heading("text", 1)', desc: 'heading' },
            { keyword: 'link', template: 'link("text", "url")', desc: 'hyperlink' },
            // CSS Styling Properties
            { keyword: 'color', template: 'color: "#000000"', desc: 'text color' },
            { keyword: 'background-color', template: 'background-color: "#ffffff"', desc: 'background color' },
            { keyword: 'font-size', template: 'font-size: "16px"', desc: 'font size' },
            { keyword: 'font-weight', template: 'font-weight: "bold"', desc: 'font weight' },
            { keyword: 'font-family', template: 'font-family: "Arial, sans-serif"', desc: 'font family' },
            { keyword: 'padding', template: 'padding: "10px"', desc: 'padding' },
            { keyword: 'margin', template: 'margin: "10px"', desc: 'margin' },
            { keyword: 'border', template: 'border: "1px solid #000"', desc: 'border' },
            { keyword: 'border-radius', template: 'border-radius: "5px"', desc: 'border radius' },
            { keyword: 'width', template: 'width: "100px"', desc: 'width' },
            { keyword: 'height', template: 'height: "100px"', desc: 'height' },
            { keyword: 'display', template: 'display: "block"', desc: 'display type' },
            { keyword: 'text-align', template: 'text-align: "center"', desc: 'text alignment' },
            { keyword: 'line-height', template: 'line-height: "1.5"', desc: 'line height' },
            { keyword: 'opacity', template: 'opacity: "1"', desc: 'opacity' },
            { keyword: 'box-shadow', template: 'box-shadow: "0 2px 4px rgba(0,0,0,0.1)"', desc: 'box shadow' },
            { keyword: 'text-decoration', template: 'text-decoration: "none"', desc: 'text decoration' },
            { keyword: 'letter-spacing', template: 'letter-spacing: "1px"', desc: 'letter spacing' },
            { keyword: 'transform', template: 'transform: "scale(1)"', desc: 'transform' },
            { keyword: 'transition', template: 'transition: "all 0.3s ease"', desc: 'transition' },
            { keyword: 'cursor', template: 'cursor: "pointer"', desc: 'cursor style' },
            { keyword: 'overflow', template: 'overflow: "hidden"', desc: 'overflow' },
            { keyword: 'position', template: 'position: "relative"', desc: 'position' },
            { keyword: 'z-index', template: 'z-index: "1"', desc: 'z-index' },
            { keyword: 'flex', template: 'flex: "1"', desc: 'flex property' },
            { keyword: 'grid', template: 'grid: "auto"', desc: 'grid property' },
            // Module imports
            { keyword: '$attach', template: '$attach, @neote;', desc: 'import neote' },
            // Extensions
            { keyword: 'ext.execute', template: 'ext.execute("ext_id")', desc: 'run extension' },
            { keyword: 'ext.list', template: 'ext.list()', desc: 'list extensions' }
        ];

        function showAutocomplete(matches, x, y) {
            hideAutocomplete();
            if (matches.length === 0) return;

            completions = matches;
            selectedIndex = 0;

            autocompleteDropdown = document.createElement('div');
            autocompleteDropdown.className = 'autocomplete-dropdown';
            autocompleteDropdown.style.left = x + 'px';
            autocompleteDropdown.style.top = y + 'px';

            matches.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item' + (idx === 0 ? ' selected' : '');
                div.innerHTML = `<span class="keyword">${item.keyword}</span><span class="desc">${item.desc}</span>`;
                div.onclick = () => applyCompletion(item);
                autocompleteDropdown.appendChild(div);
            });

            document.body.appendChild(autocompleteDropdown);
        }

        function hideAutocomplete() {
            if (autocompleteDropdown) {
                autocompleteDropdown.remove();
                autocompleteDropdown = null;
                selectedIndex = -1;
                completions = [];
            }
        }

        function applyCompletion(item) {
            const pos = codeEditor.selectionStart;
            const text = codeEditor.value;
            const lineStart = text.lastIndexOf('\n', pos - 1) + 1;
            const currentLine = text.substring(lineStart, pos);
            const wordMatch = currentLine.match(/([a-zA-Z0-9_.]+)$/);

            if (wordMatch) {
                const wordStart = lineStart + currentLine.lastIndexOf(wordMatch[1]);
                codeEditor.value = text.substring(0, wordStart) + item.template + text.substring(pos);
                codeEditor.selectionStart = codeEditor.selectionEnd = wordStart + item.template.length;
            }

            hideAutocomplete();
            codeEditor.focus();
            updateLineNumbers(codeEditor.value);
        }

        codeEditor.addEventListener('input', function (e) {
            const pos = this.selectionStart;
            const text = this.value;
            const lineStart = text.lastIndexOf('\n', pos - 1) + 1;
            const currentLine = text.substring(lineStart, pos);
            const wordMatch = currentLine.match(/([a-zA-Z0-9_.]+)$/);

            if (wordMatch && wordMatch[1].length > 0) {
                const word = wordMatch[1];
                const matches = COMPLETIONS.filter(c => c.keyword.startsWith(word));

                if (matches.length > 0) {
                    const rect = this.getBoundingClientRect();
                    const lines = text.substring(0, pos).split('\n');
                    const lineNum = lines.length - 1;
                    const charPos = lines[lines.length - 1].length;

                    const x = rect.left + 50 + (charPos * 8.4);
                    const y = rect.top + 12 + (lineNum * 21);

                    showAutocomplete(matches, x, y);
                } else {
                    hideAutocomplete();
                }
            } else {
                hideAutocomplete();
            }
        });

        codeEditor.addEventListener('keydown', function (e) {
            if (autocompleteDropdown) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % completions.length;
                    updateAutocompleteSelection();
                    return;
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = (selectedIndex - 1 + completions.length) % completions.length;
                    updateAutocompleteSelection();
                    return;
                }
                if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectedIndex < completions.length) {
                        applyCompletion(completions[selectedIndex]);
                    }
                    return;
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    hideAutocomplete();
                    return;
                }
            }

            if (e.key === 'Tab' && !autocompleteDropdown) {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
                updateLineNumbers(this.value);
            }
        });

        function updateAutocompleteSelection() {
            if (!autocompleteDropdown) return;
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, idx) => {
                item.classList.toggle('selected', idx === selectedIndex);
            });
        }

        document.addEventListener('click', function (e) {
            if (autocompleteDropdown && !autocompleteDropdown.contains(e.target) && e.target !== codeEditor) {
                hideAutocomplete();
            }
        });

        function showPanel(panelId) {
            document.getElementById('panel-output').classList.add('hidden');
            document.getElementById('panel-terminal').classList.add('hidden');
            document.getElementById('panel-problems').classList.add('hidden');

            document.getElementById('tab-output').classList.remove('active');
            document.getElementById('tab-terminal').classList.remove('active');
            document.getElementById('tab-problems').classList.remove('active');

            document.getElementById(`panel-${panelId}`).classList.remove('hidden');
            document.getElementById(`tab-${panelId}`).classList.add('active');

            if (panelId === 'terminal') {
                document.getElementById('terminal-input').focus();
            }
        }

        // --- RESIZING LOGIC ---
        function initResizing() {
            let isResizing = false;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.classList.add('select-none');
                document.body.style.cursor = 'row-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const container = editorPane.parentElement;
                const containerRect = container.getBoundingClientRect();

                let newEditorHeight = e.clientY - containerRect.top;
                const maxEditorHeight = containerRect.height - MIN_PANEL_HEIGHT;

                newEditorHeight = Math.min(newEditorHeight, maxEditorHeight);
                newEditorHeight = Math.max(newEditorHeight, MIN_PANEL_HEIGHT);

                const editorHeightPercent = (newEditorHeight / containerRect.height) * 100;
                const panelHeightPercent = 100 - editorHeightPercent;

                editorPane.style.height = `${editorHeightPercent}%`;
                panelPane.style.height = `${panelHeightPercent}%`;

                syncScroll();
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.classList.remove('select-none');
                document.body.style.cursor = 'default';
            });
        }

        // --- TERMINAL LOGIC ---
        function writeToTerminal(text, type = 'default') {
            const line = document.createElement('div');
            line.className = 'text-xs font-mono';

            if (type === 'prompt') {
                line.innerHTML = `<span class="text-purple-400 font-bold">$></span> <span class="text-secondary">${text}</span>`;
            } else if (type === 'error') {
                line.className += ' text-danger';
                line.textContent = `[ERROR]: ${text}`;
            } else if (type === 'success') {
                line.className += ' text-success';
                line.textContent = `[SUCCESS]: ${text}`;
            } else if (type === 'log') {
                line.className += ' text-secondary';
                line.textContent = text;
            } else {
                line.className += ' text-secondary';
                line.textContent = text;
            }
            terminalHistory.appendChild(line);
            terminalHistory.scrollTop = terminalHistory.scrollHeight;
        }

        function checkTerminalCommand(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('terminal-input');
                const command = input.value.trim();
                input.value = '';

                if (command) {
                    handleTerminalCommand(command);
                }
            }
        }

        function handleTerminalCommand(command) {
            const commandLower = command.toLowerCase();

            writeToTerminal(command, 'prompt');

            if (commandLower === 'clear') {
                terminalHistory.innerHTML = '';
                writeToTerminal('Terminal history cleared.', 'success');
                return;
            }

            // --- ECHO COMMAND ---
            if (commandLower.startsWith('#echo')) {
                const msg = command.slice(5).trim();
                if (!msg) {
                    writeToTerminal("Nothing to echo.", "error");
                } else {
                    writeToTerminal(msg, "default");
                }
                return;
            }

            // --- STORAGE FOR USER CUSTOM FUNCS ---
            if (!window.neoteFuncs) window.neoteFuncs = {};

            // --- DEFINE A FUNC: func[name] < content >
            const funcDefineMatch = command.match(/^func\[(.+?)\]\s*<\s*([\s\S]+)\s*>$/);
            if (funcDefineMatch) {
                const funcName = funcDefineMatch[1].trim();
                const funcContent = funcDefineMatch[2].trim();

                window.neoteFuncs[funcName] = funcContent;

                writeToTerminal(`Function "${funcName}" saved.`, "success");
                return;
            }

            // --- RUN A FUNC: :name ---
            if (command.startsWith(':')) {
                const funcName = command.slice(1).trim();

                if (!window.neoteFuncs[funcName]) {
                    writeToTerminal(`Function "${funcName}" not found.`, "error");
                    return;
                }

                const funcCommand = window.neoteFuncs[funcName];

                // Recursively execute its content like a normal terminal command
                handleTerminalCommand(funcCommand);
                return;
            }


            // --- PING COMMAND ---
            const pingMatch = command.match(/^#ping\s+-\s*'(.*)'$/);
            if (pingMatch) {
                const url = pingMatch[1];
                writeToTerminal(`Pinging ${url}...`, "default");

                // Simulated ping loop
                for (let i = 0; i < 7; i++) {
                    setTimeout(() => {
                        const ms = Math.floor(Math.random() * 50) + 20; // 20-70ms
                        writeToTerminal(`Reply from ${url}: ${ms}ms`, "success");
                    }, 300 * (i + 1));
                }
                return;
            }

            // --- RANDOM TERMINAL COMMAND: #random <max> ---
            if (commandLower.startsWith('#random')) {
                const args = command.split(' ').slice(1);
                const max = parseInt(args[0]);

                if (isNaN(max) || max <= 0) {
                    writeToTerminal("Usage: #random <number>", "error");
                    return;
                }

                const result = Math.floor(Math.random() * max);
                writeToTerminal(`Random(${max}) => ${result}`, "success");
                return;
            }


            // --- BASE64 ENCODE ---
            if (commandLower.startsWith('#encode')) {
                const text = command.slice(7).trim();
                if (!text) {
                    writeToTerminal("Usage: #encode yourTextHere", "error");
                    return;
                }
                try {
                    const encoded = btoa(text);
                    writeToTerminal(encoded, "success");
                } catch (e) {
                    writeToTerminal("Encoding failed. Make sure text is valid.", "error");
                }
                return;
            }

            // --- COMMENT HANDLER (! comment ) ---
            if (command.trim().startsWith('!')) {
                // ignore comment silently
                return;
            }

            // inline comments: command ! comment
            if (command.includes('!')) {
                command = command.split('!')[0].trim();
                if (!command) return; // if nothing left, ignore
            }


            // --- BASE64 DECODE ---
            if (commandLower.startsWith('#decode')) {
                const encoded = command.slice(7).trim();
                if (!encoded) {
                    writeToTerminal("Usage: #decode base64TextHere", "error");
                    return;
                }
                try {
                    const decoded = atob(encoded);
                    writeToTerminal(decoded, "success");
                } catch (e) {
                    writeToTerminal("Decoding failed. Make sure Base64 is valid.", "error");
                }
                return;
            }

            const teachMatch = command.match(/^#?teach\s+-(.*)$/i);
            if (teachMatch) {
                const tag = teachMatch[1].trim().toLowerCase();

                if (tag === 'all') {
                    writeToTerminal('--- Neote Plus Tags Refresher ---', 'success');
                    writeToTerminal('Here\'s the tea on all the tags:', 'default');
                    Object.keys(NEOTE_TAGS).forEach(key => {
                        writeToTerminal(`[${key}]: ${NEOTE_TAGS[key].desc}`, 'default');
                    });
                    writeToTerminal('--------------------------------', 'success');
                    return;
                }

                if (NEOTE_TAGS[tag]) {
                    const info = NEOTE_TAGS[tag];
                    writeToTerminal(`--- Neote Tag: ${tag} ---`, 'success');
                    writeToTerminal(`Description: ${info.desc}`, 'default');
                    writeToTerminal(`Example: ${info.example}`, 'default');
                    writeToTerminal('--------------------------------', 'success');
                    return;
                }

                writeToTerminal(`Tag '${tag}'? Sounds like a skill issue, 'cause IDK what that is. Try 'teach -all'.`, 'error');
                return;
            }

            if (commandLower === 'neote bash') {
                writeToTerminal('Neote Bash activated. Available commands: n -\'link\', show -time, show -version, sys -run, and math equations.', 'success');
                return;
            }

            const linkMatch = command.match(/^#?n\s+-\s*'(.*)'$/);
            if (linkMatch) {
                const url = linkMatch[1];
                try {
                    const absoluteUrl = url.startsWith('http') ? url : `https://${url}`;
                    window.open(absoluteUrl, '_blank');
                    writeToTerminal(`Opening site in a new tab: ${url}`, 'success');
                } catch (e) {
                    writeToTerminal(`Invalid link format or operation blocked: ${url}`, 'error');
                }
                return;
            }

            if (commandLower === 'show -time' || commandLower === '#show -time') {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateString = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                writeToTerminal(`Current System Time: ${dateString} ${timeString}`, 'default');
                return;
            }

            if (commandLower === 'show -version' || commandLower === '#show -version') {
                writeToTerminal(`Neote Plus Version: ${NEOTE_VERSION}`, 'default');
                return;
            }

            if (commandLower === 'sys -run' || commandLower === '#sys -run') {
                writeToTerminal('Executing current file...', 'success');
                runNeoteCode();
                return;
            }

            if (isMathExpression(command)) {
                try {
                    const result = new Function('return ' + command)();
                    writeToTerminal(`Result: ${result}`, 'success');
                } catch (e) {
                    writeToTerminal(`Math Error: ${e.message}`, 'error');
                }
                return;
            }

            if (commandLower.startsWith('ls') || commandLower.startsWith('cd') || commandLower.startsWith('pwd')) {
                writeToTerminal(`Bash command '${command.split(' ')[0]}' recognized, but this is a simulated environment. Try 'neote bash'.`, 'default');
                return;
            }

            writeToTerminal(`Unknown command: ${command}. Type 'neote bash' for specific commands, 'teach -all' to learn tags, 'sys -run' to execute code, or enter a math equation to calculate.`, 'error');
        }

        function isMathExpression(input) {
            const mathOperators = ['+', '-', '*', '/', '%', '(', ')', '^', '**'];
            const mathFunctions = ['Math.', 'Math.sqrt', 'Math.pow', 'Math.sin', 'Math.cos', 'Math.tan', 'Math.log', 'Math.abs'];

            if (!input.trim()) return false;

            const knownCommands = ['clear', 'neote', 'teach', 'n', 'show', 'sys', 'ls', 'cd', 'pwd'];
            const firstWord = input.trim().split(/\s+/)[0].toLowerCase();
            if (knownCommands.includes(firstWord)) return false;

            const hasMathOperators = mathOperators.some(op => input.includes(op));
            const hasMathFunctions = mathFunctions.some(func => input.includes(func));
            const isNumber = !isNaN(parseFloat(input)) && isFinite(input);

            return hasMathOperators || hasMathFunctions || isNumber;
        }

        // --- OUTPUT & MODAL FUNCTIONS ---
        function displayOutput(message, isError = false, terminalOnly = false) {
            if (!terminalOnly) {
                const output = document.createElement('div');
                output.className = `showcase-output ${isError ? 'showcase-error' : ''}`;
                output.textContent = message;
                outputPanel.appendChild(output);
                outputPanel.scrollTop = outputPanel.scrollHeight;
            }

            if (message.startsWith('[call]:') || message.startsWith('[Neote Plus]:') || message.startsWith('[DB]:') || message.startsWith('[Storage]:') || message.startsWith('[DOM]:') || message.startsWith('[Geo]:') || message.startsWith('[Recovery]:') || message.startsWith('[expand]:') || terminalOnly || isError) {
                const logType = isError ? 'error' : 'log';
                let logMessage = message.replace(/(\[call\]:|\[Neote Plus\]:|\[DB\]:|\[Storage\]:|\[DOM\]:|\[Geo\]:|\[Recovery\]:|\[expand\]:)/, '').trim();
                writeToTerminal(logMessage, logType);
            }

            if (isError) {
                const errorLog = document.createElement('div');
                errorLog.className = 'text-danger font-mono text-xs mt-1 border-bottom border-danger pb-1';
                errorLog.innerHTML = `<span class="font-bold">ERROR:</span> ${message.replace(/RUNTIME ERROR: /, '').replace(/PARSING ERROR: /, '').trim()}`;
                problemsPanel.appendChild(errorLog);
            }
        }

        function updateVariableViewer() {
            let info = 'Variables: ';
            const keys = Object.keys(neoteVariables);
            if (keys.length === 0) {
                info += 'None.';
            } else {
                info += keys.map(key => `<span style="color: var(--highlight-purple-light);">${key}</span>`).join(', ');
            }
            variableViewer.innerHTML = info;
        }

        function clearOutput() {
            outputPanel.innerHTML = '<div class="showcase-output text-center" style="color: var(--text-secondary);">Run the code to see the application\'s final output (showcase, buttons, media).</div>';
            problemsPanel.innerHTML = '<div class="text-white">All errors, warnings, and problems will be listed here.</div>';

            terminalHistory.innerHTML = '<div class="text-success">Neote Plus Interpreter Ready. Use \'neote bash\' for system commands, \'#teach -all\' to learn tags, or enter math equations to calculate.</div>';
        }

        function showModal(title, message, isPrompt = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.value = '';

            modal.classList.remove('hidden');

            if (isPrompt) {
                modalInput.classList.remove('hidden');
                modalInput.focus();
                modalOkButton.textContent = 'Submit';
                return new Promise(resolve => {
                    modalResolver = resolve;
                });
            } else {
                modalInput.classList.add('hidden');
                modalOkButton.textContent = 'OK';
                return new Promise(resolve => {
                    modalResolver = resolve;
                });
            }
        }

        modalOkButton.onclick = () => {
            const isPrompt = !modalInput.classList.contains('hidden');
            const result = isPrompt ? modalInput.value : undefined;

            modal.classList.add('hidden');

            if (modalResolver) {
                modalResolver(result);
                modalResolver = null;
            }

            if (isPrompt) {
                isRunningImprop = false;
                continueExecution();
            }
        };

        // --- FILE EXPLORER FUNCTIONS ---
        function renderFileExplorer() {
            const explorerContainer = document.getElementById('file-explorer');
            explorerContainer.innerHTML = '';

            const allFiles = [...Object.keys(openFiles), ...getSavedFilesList().filter(f => !openFiles[f])];
            const uniqueFiles = [...new Set(allFiles)];

            uniqueFiles.forEach(fileName => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${fileName === currentFile ? 'active' : ''}`;

                const fileIcon = document.createElement('i');
                fileIcon.className = 'bi bi-file-earmark-code text-warning me-2';

                const fileName_span = document.createElement('span');
                fileName_span.className = 'text-sm';
                fileName_span.textContent = fileName;

                const actions = document.createElement('div');
                actions.className = 'file-actions';

                const renameBtn = document.createElement('button');
                renameBtn.className = 'file-action-btn';
                renameBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                renameBtn.title = 'Rename';
                renameBtn.onclick = (e) => {
                    e.stopPropagation();
                    renameFile(fileName);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'file-action-btn';
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.title = 'Delete';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteFile(fileName);
                };

                actions.appendChild(renameBtn);
                actions.appendChild(deleteBtn);

                fileItem.appendChild(fileIcon);
                fileItem.appendChild(fileName_span);
                fileItem.appendChild(actions);

                fileItem.onclick = () => {
                    if (openFiles[fileName]) {
                        switchToFile(fileName);
                    } else {
                        openFileFromExplorer(fileName);
                    }
                };

                explorerContainer.appendChild(fileItem);
            });
        }

        function openFileFromExplorer(fileName) {
            try {
                const data = localStorage.getItem(`neote_file_${fileName}`);
                if (data) {
                    const fileData = JSON.parse(data);
                    openFiles[fileName] = {
                        content: fileData.content,
                        saved: true
                    };
                    switchToFile(fileName);
                }
            } catch (e) {
                showModal('Error', `Failed to load file: ${e.message}`, false);
            }
        }

        function renameFile(oldName) {
            showModal('Rename File', `Enter new name for "${oldName}":`, true).then(newName => {
                if (newName && newName.trim() && newName !== oldName) {
                    newName = newName.trim();
                    if (!newName.endsWith('.neote')) {
                        newName += '.neote';
                    }

                    if (getSavedFilesList().includes(newName) || openFiles[newName]) {
                        showModal('Error', `File "${newName}" already exists.`, false);
                        return;
                    }

                    const data = localStorage.getItem(`neote_file_${oldName}`);
                    if (data) {
                        localStorage.setItem(`neote_file_${newName}`, data);
                        localStorage.removeItem(`neote_file_${oldName}`);
                    }

                    if (openFiles[oldName]) {
                        openFiles[newName] = openFiles[oldName];
                        delete openFiles[oldName];

                        if (currentFile === oldName) {
                            currentFile = newName;
                        }
                    }

                    renderFileTabs();
                    renderFileExplorer();
                    updateHeaderTitle();
                }
            });
        }

        function deleteFile(fileName) {
            if (confirm(`Are you sure you want to delete "${fileName}"?`)) {
                localStorage.removeItem(`neote_file_${fileName}`);

                if (openFiles[fileName]) {
                    delete openFiles[fileName];

                    const remainingFiles = Object.keys(openFiles);
                    if (remainingFiles.length === 0) {
                        openFiles['untitled.neote'] = {
                            content: `$attach, @neote;\n\n// New file\nshowcase("Hello World!")`,
                            saved: false
                        };
                        currentFile = 'untitled.neote';
                    } else if (fileName === currentFile) {
                        currentFile = remainingFiles[0];
                    }

                    if (currentFile) {
                        switchToFile(currentFile);
                    }
                }

                renderFileTabs();
                renderFileExplorer();
            }
        }

        // --- FILE MANAGEMENT FUNCTIONS ---
        function renderFileTabs() {
            const tabsContainer = document.getElementById('file-tabs');
            tabsContainer.innerHTML = '';

            Object.keys(openFiles).forEach(fileName => {
                const tab = document.createElement('div');
                tab.className = `file-tab ${fileName === currentFile ? 'active' : ''} ${!openFiles[fileName].saved ? 'unsaved' : ''}`;

                const nameSpan = document.createElement('span');
                nameSpan.textContent = fileName;
                nameSpan.className = 'truncate';
                tab.appendChild(nameSpan);

                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '<i class="bi bi-x"></i>';
                closeBtn.className = 'close-btn text-secondary';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeFile(fileName);
                };
                tab.appendChild(closeBtn);

                tab.onclick = () => switchToFile(fileName);
                tabsContainer.appendChild(tab);
            });
        }

        function switchToFile(fileName) {
            if (currentFile && openFiles[currentFile]) {
                openFiles[currentFile].content = codeEditor.value;
            }

            currentFile = fileName;
            codeEditor.value = openFiles[fileName].content;
            updateLineNumbers(openFiles[fileName].content);
            renderFileTabs();
            updateHeaderTitle();
        }

        function createNewFile() {
            showModal('Create New File', 'Enter file name:', true).then(fileName => {
                if (fileName && fileName.trim()) {
                    fileName = fileName.trim();
                    if (!fileName.endsWith('.neote')) {
                        fileName += '.neote';
                    }

                    if (openFiles[fileName]) {
                        showModal('File Exists', `File "${fileName}" already exists.`, false);
                        return;
                    }

                    openFiles[fileName] = {
                        content: `$attach, @neote;\n\n// New Neote file\nshowcase("Hello from ${fileName}!")`,
                        saved: false
                    };

                    switchToFile(fileName);
                }
            });
        }

        function saveCurrentFile() {
            if (currentFile && openFiles[currentFile]) {
                openFiles[currentFile].content = codeEditor.value;
                openFiles[currentFile].saved = true;

                // Save to localStorage
                const fileData = {
                    content: openFiles[currentFile].content,
                    lastModified: new Date().toISOString()
                };
                localStorage.setItem(`neote_file_${currentFile}`, JSON.stringify(fileData));

                renderFileTabs();
                renderFileExplorer();
                showModal('File Saved', `"${currentFile}" has been saved successfully.`, false);
            }
        }

        function closeFile(fileName) {
            if (!openFiles[fileName].saved) {
                if (!confirm(`"${fileName}" has unsaved changes. Close anyway?`)) {
                    return;
                }
            }

            delete openFiles[fileName];

            const remainingFiles = Object.keys(openFiles);
            if (remainingFiles.length === 0) {
                openFiles['untitled.neote'] = {
                    content: `$attach, @neote;\n\n// New file\nshowcase("Hello World!")`,
                    saved: false
                };
                currentFile = 'untitled.neote';
            } else if (fileName === currentFile) {
                currentFile = remainingFiles[0];
            }

            if (currentFile) {
                switchToFile(currentFile);
            }
        }

        function openFileDialog() {
            const savedFiles = getSavedFilesList();
            if (savedFiles.length === 0) {
                showModal('No Saved Files', 'No saved files found. Create and save a file first.', false);
                return;
            }

            const fileList = savedFiles.map(f => `‚Ä¢ ${f}`).join('\n');
            showModal('Open File', `Available files:\n${fileList}\n\nEnter file name to open:`, true).then(fileName => {
                if (fileName && fileName.trim()) {
                    fileName = fileName.trim();
                    if (!fileName.endsWith('.neote')) {
                        fileName += '.neote';
                    }

                    // Load from localStorage
                    try {
                        const data = localStorage.getItem(`neote_file_${fileName}`);
                        if (data) {
                            const fileData = JSON.parse(data);
                            if (!openFiles[fileName]) {
                                openFiles[fileName] = {
                                    content: fileData.content,
                                    saved: true
                                };
                            }
                            switchToFile(fileName);
                        } else {
                            showModal('File Not Found', `File "${fileName}" not found.`, false);
                        }
                    } catch (e) {
                        showModal('Error', `Failed to load file: ${e.message}`, false);
                    }
                }
            });
        }

        function updateHeaderTitle() {
            const headerTitle = document.getElementById('header-title');
            if (headerTitle) {
                headerTitle.textContent = `Neote IDE - ${currentFile}`;
            }
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        function getSavedFilesList() {
            const files = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('neote_file_')) {
                    files.push(key.replace('neote_file_', ''));
                }
            }
            return files.sort();
        }
        // --- NEOTE PLUS CORE PARSER ---
        function interpolateString(rawValue) {
            let str = rawValue.trim().replace(/^"|"$/g, '').trim();

            str = str.replace(/\$([a-zA-Z0-9_.\[\]]+)/g, (match, varPath) => {
                const pathParts = varPath.split('.');
                let value = neoteVariables;

                for (const part of pathParts) {
                    if (part.includes('[') && part.includes(']')) {
                        const arrayName = part.split('[')[0];
                        const indexStr = part.split('[')[1].split(']')[0];

                        if (value[arrayName] && Array.isArray(value[arrayName])) {
                            const index = parseInt(indexStr);
                            value = value[arrayName][index];
                        } else {
                            return match;
                        }
                    } else {
                        value = value[part];
                    }

                    if (value === undefined) {
                        return match;
                    }
                }

                return String(value);
            });
            return str;
        }

        function callFunction(funcName) {
            const funcBlock = neoteFunctions[funcName];
            if (funcBlock) {
                const lines = funcBlock.split('\n').map(line => line.trim()).filter(line => line.length > 0 && !line.startsWith('//'));
                executeLines(lines);
            } else {
                displayOutput(`RUNTIME ERROR: Attempted to call unknown function '${funcName}'.`, true);
            }
        }

        let executionQueue = [];
        let executionIndex = 0;

        function parseCodeBlock(codeBlock) {
            if (codeBlock === codeEditor.value) {
                const lines = codeBlock.split('\n').map(line => line.trim());
                executionQueue = [];
                let inBlock = false;
                let blockDepth = 0;

                for (const line of lines) {
                    if (line.match(/^(func|macro)\s+[a-zA-Z0-9_]+/)) {
                        inBlock = true;
                        blockDepth = 0;
                        continue;
                    }

                    if (inBlock) {
                        if (line.includes('{')) blockDepth++;
                        if (line.includes('}')) blockDepth--;

                        if (blockDepth === 0 && line === '}') {
                            inBlock = false;
                        }
                        continue;
                    }

                    if (!inBlock && line.length > 0 && !line.startsWith('//')) {
                        executionQueue.push(line);
                    }
                }
                executionIndex = 0;
            } else {
                const lines = codeBlock.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('//'));
                executeLines(lines);
            }
        }

        function executeLines(lines) {
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // Handle multi-line blocks (anything with { but not })
                if (line.includes('{') && !line.includes('}')) {
                    let completeBlock = line;
                    let j = i + 1;
                    let braceCount = 1;

                    while (j < lines.length && braceCount > 0) {
                        const nextLine = lines[j].trim();
                        if (nextLine.includes('{')) braceCount++;
                        if (nextLine.includes('}')) braceCount--;

                        if (braceCount > 0) {
                            completeBlock += ' ' + nextLine;
                        } else {
                            completeBlock += ' ' + nextLine;
                        }
                        j++;
                    }

                    line = completeBlock;
                    i = j - 1;
                }

                // Function definition (nested or top-level handled by executeLines)
                let matchFunc = line.match(/^(func|macro)\s+([a-zA-Z0-9_]+)(?:\(([^)]*)\))?\s*\{/);
                if (matchFunc) {
                    const type = matchFunc[1];
                    const name = matchFunc[2];
                    const params = matchFunc[3] ? matchFunc[3].split(',').map(p => p.trim()) : [];

                    // Extract body
                    let body = '';
                    const firstBrace = line.indexOf('{');
                    const lastBrace = line.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace !== -1) {
                        body = line.substring(firstBrace + 1, lastBrace);
                    }

                    if (type === 'func') {
                        neoteFunctions[name] = body;
                    } else {
                        neoteMacros[name] = { params, body };
                    }
                    continue;
                }

                // Global styling
                let matchGlobal = line.match(/^global\(\)\s*\{([^}]*)}/);
                if (matchGlobal) {
                    const styleBlock = matchGlobal[1].trim();
                    const styles = parseStyleBlock(styleBlock);
                    applyStylesToElement(outputPanel, styles);
                    displayOutput(`[global]: Applied global styles to output panel`, false);
                    continue;
                }

                // If/Else conditional
                let matchIf = line.match(/^if\s*\((.+?)\)\s*\{([^}]*)}(?:\s*else\s*\{([^}]*)})?/);
                if (matchIf) {
                    const condition = matchIf[1].trim();
                    const ifBody = matchIf[2].trim();
                    const elseBody = matchIf[3] ? matchIf[3].trim() : null;

                    try {
                        const evalCondition = condition.replace(/([a-zA-Z_][a-zA-Z0-9_]*)/g, (match) => {
                            if (['true', 'false', 'null', 'undefined'].includes(match)) return match;
                            return neoteVariables.hasOwnProperty(match) ? JSON.stringify(neoteVariables[match]) : match;
                        });

                        const result = Function(`return ${evalCondition}`)();

                        if (result) {
                            const ifLines = ifBody.split(';').map(l => l.trim()).filter(l => l);
                            executeLines(ifLines);
                        } else if (elseBody) {
                            const elseLines = elseBody.split(';').map(l => l.trim()).filter(l => l);
                            executeLines(elseLines);
                        }
                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: Invalid condition in if statement: ${e.message}`, true);
                    }
                    continue;
                }

                // Loop
                let matchLoop = line.match(/^loop\s*\((\d+)\)\s*\{([^}]*)}/);
                if (matchLoop) {
                    const iterations = parseInt(matchLoop[1]);
                    const loopBody = matchLoop[2].trim();

                    for (let loopIndex = 0; loopIndex < iterations; loopIndex++) {
                        neoteVariables['_loopIndex'] = loopIndex;
                        const loopLines = loopBody.split(';').map(l => l.trim()).filter(l => l);
                        executeLines(loopLines);
                    }
                    continue;
                }

                // Object instantiation
                let matchNew = line.match(/^st\s+([a-zA-Z0-9_]+)\s*=\s*new\s+([a-zA-Z0-9_]+)\s*\((.*)\)$/);
                if (matchNew) {
                    const varName = matchNew[1].trim();
                    const className = matchNew[2].trim();
                    const argsStr = matchNew[3].trim();

                    if (!neoteClasses[className]) {
                        displayOutput(`RUNTIME ERROR: Class '${className}' not defined.`, true);
                        continue;
                    }

                    const instance = { _class: className };
                    const classCode = neoteClasses[className];
                    const classLines = classCode.split('\n').map(l => l.trim()).filter(l => l);

                    let initBody = null;
                    let initParams = [];
                    let methods = {};

                    for (let i = 0; i < classLines.length; i++) {
                        const cLine = classLines[i];

                        const initMatch = cLine.match(/^init\s*\(([^)]*)\)\s*\{/);
                        if (initMatch) {
                            initParams = initMatch[1].split(',').map(p => p.trim()).filter(p => p);
                            let depth = 1;
                            let body = [];
                            i++;
                            while (i < classLines.length && depth > 0) {
                                if (classLines[i].includes('{')) depth++;
                                if (classLines[i].includes('}')) depth--;
                                if (depth > 0) body.push(classLines[i]);
                                i++;
                            }
                            initBody = body.join('\n');
                            i--;
                            continue;
                        }

                        const methodMatch = cLine.match(/^method\s+([a-zA-Z0-9_]+)\s*\(([^)]*)\)\s*\{/);
                        if (methodMatch) {
                            const methodName = methodMatch[1];
                            const methodParams = methodMatch[2].split(',').map(p => p.trim()).filter(p => p);
                            let depth = 1;
                            let body = [];
                            i++;
                            while (i < classLines.length && depth > 0) {
                                if (classLines[i].includes('{')) depth++;
                                if (classLines[i].includes('}')) depth--;
                                if (depth > 0) body.push(classLines[i]);
                                i++;
                            }
                            methods[methodName] = { params: methodParams, body: body.join('\n') };
                            i--;
                        }
                    }

                    if (initBody) {
                        const args = argsStr ? argsStr.split(',').map(a => a.trim()) : [];
                        const oldVars = { ...neoteVariables };

                        initParams.forEach((param, idx) => {
                            if (args[idx]) {
                                let val = args[idx];
                                if (val.startsWith('"') && val.endsWith('"')) {
                                    val = interpolateString(val);
                                } else if (neoteVariables[val] !== undefined) {
                                    val = neoteVariables[val];
                                } else {
                                    try { val = Function(`return ${val}`)(); } catch (e) { }
                                }
                                instance[param] = val;
                                neoteVariables[param] = val;
                            }
                        });

                        neoteVariables['this'] = instance;
                        const initLines = initBody.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('/'));
                        executeLines(initLines);

                        Object.keys(neoteVariables).forEach(key => {
                            if (key !== 'this' && !initParams.includes(key) && !oldVars.hasOwnProperty(key)) {
                                instance[key] = neoteVariables[key];
                            }
                        });

                        Object.keys(instance).forEach(key => {
                            if (!key.startsWith('_') && key !== 'this') {
                                neoteVariables[key.replace('this.', '')] = instance[key];
                            }
                        });

                        neoteVariables = oldVars;
                        delete neoteVariables['this'];
                    }

                    instance._methods = methods;
                    neoteVariables[varName] = instance;
                    updateVariableViewer();
                    continue;
                }

                // Method call
                let matchMethodCall = line.match(/^([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\s*\((.*)\)$/);
                if (matchMethodCall) {
                    const objName = matchMethodCall[1].trim();
                    const methodName = matchMethodCall[2].trim();
                    const argsStr = matchMethodCall[3].trim();

                    if (neoteVariables[objName]) {
                        const obj = neoteVariables[objName];

                        // Check for native method (for UI elements)
                        if (typeof obj[methodName] === 'function') {
                            const args = argsStr ? argsStr.split(',').map(a => {
                                a = a.trim();
                                if (a.startsWith('"') && a.endsWith('"')) return interpolateString(a);
                                if (neoteVariables[a] !== undefined) return neoteVariables[a];
                                try { return Function(`return ${a}`)(); } catch (e) { return a; }
                            }) : [];
                            obj[methodName](...args);
                            continue;
                        }

                        // Existing logic for Neote class methods
                        if (obj._methods && obj._methods[methodName]) {
                            const method = obj._methods[methodName];
                            const args = argsStr ? argsStr.split(',').map(a => a.trim()) : [];
                            const oldVars = { ...neoteVariables };

                            method.params.forEach((param, idx) => {
                                if (args[idx]) {
                                    let val = args[idx];
                                    if (val.startsWith('"') && val.endsWith('"')) {
                                        val = interpolateString(val);
                                    } else if (neoteVariables[val] !== undefined) {
                                        val = neoteVariables[val];
                                    } else {
                                        try { val = Function(`return ${val}`)(); } catch (e) { }
                                    }
                                    neoteVariables[param] = val;
                                }
                            });

                            neoteVariables['this'] = obj;
                            const methodLines = method.body.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('/'));
                            executeLines(methodLines);

                            Object.keys(neoteVariables).forEach(key => {
                                if (key !== 'this' && !method.params.includes(key) && !oldVars.hasOwnProperty(key)) {
                                    obj[key] = neoteVariables[key];
                                }
                            });

                            neoteVariables = oldVars;
                            neoteVariables[objName] = obj;
                            delete neoteVariables['this'];
                            updateVariableViewer();
                        } else {
                            displayOutput(`RUNTIME ERROR: Method '${methodName}' not found in object '${objName}'.`, true);
                        }
                    }
                    continue;
                }

                // Property assignment (this.property)
                let matchThisProp = line.match(/^st\s+this\.([a-zA-Z0-9_]+)\s*=\s*(.*)$/);
                if (matchThisProp && neoteVariables['this']) {
                    const propName = matchThisProp[1].trim();
                    let rawValue = matchThisProp[2].trim();
                    let finalValue;

                    if (rawValue.startsWith('"') && rawValue.endsWith('"')) {
                        finalValue = interpolateString(rawValue);
                    } else if (neoteVariables[rawValue] !== undefined) {
                        finalValue = neoteVariables[rawValue];
                    } else {
                        try { finalValue = Function(`return ${rawValue}`)(); } catch (e) { finalValue = rawValue; }
                    }

                    neoteVariables['this'][propName] = finalValue;
                    continue;
                }

                // Property assignment (variable.property = value)
                let matchPropAssign = line.match(/^([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\s*=\s*(.*)$/);
                if (matchPropAssign) {
                    const varName = matchPropAssign[1].trim();
                    const propName = matchPropAssign[2].trim();
                    let rawValue = matchPropAssign[3].trim();

                    if (neoteVariables[varName]) {
                        let finalValue;
                        if (rawValue.startsWith('"') && rawValue.endsWith('"')) {
                            finalValue = interpolateString(rawValue);
                        } else if (neoteVariables[rawValue] !== undefined) {
                            finalValue = neoteVariables[rawValue];
                        } else {
                            try { finalValue = Function(`return ${rawValue}`)(); } catch (e) { finalValue = rawValue; }
                        }

                        neoteVariables[varName][propName] = finalValue;
                        continue;
                    }
                }

                // Variable assignment
                let matchVar = line.match(/^st\s+([a-zA-Z0-9_]+)\s*=\s*(.*)$/);
                if (matchVar) {
                    const varName = matchVar[1].trim();
                    let rawValue = matchVar[2].trim();
                    let finalValue;

                    // Handle showcase assignment
                    let matchShowcaseAssign = rawValue.match(/^showcase\s*\((.*)\)(?:\s*\{([^}]*)})?/);
                    if (matchShowcaseAssign) {
                        const rawContent = matchShowcaseAssign[1].trim();
                        const styleBlock = matchShowcaseAssign[2] ? matchShowcaseAssign[2].trim() : null;
                        let content;

                        if (rawContent.startsWith('"') && rawContent.endsWith('"')) {
                            content = interpolateString(rawContent);
                        } else if (rawContent.includes('.') && !rawContent.includes('(')) {
                            const parts = rawContent.split('.');
                            let value = neoteVariables[parts[0]];
                            for (let i = 1; i < parts.length; i++) {
                                if (value && typeof value === 'object' && value[parts[i]] !== undefined) {
                                    value = value[parts[i]];
                                }
                            }
                            content = value !== undefined ? String(value) : rawContent;
                        } else {
                            try { content = String(Function(`return ${rawContent}`)()); } catch (e) { content = rawContent; }
                        }

                        let element;
                        if (styleBlock) {
                            const styles = parseStyleBlock(styleBlock);
                            element = createStyledElement('div', content, styles);
                        } else {
                            element = document.createElement('div');
                            element.textContent = content;
                        }
                        element.className = 'showcase-output';
                        outputPanel.appendChild(element);
                        outputPanel.scrollTop = outputPanel.scrollHeight;

                        // Create wrapper object
                        finalValue = {
                            _element: element,
                            _type: 'showcase',
                            delete: function () { this._element.remove(); },
                            get text() { return this._element.textContent; },
                            set text(val) { this._element.textContent = val; },
                            get html() { return this._element.innerHTML; },
                            set html(val) { this._element.innerHTML = val; }
                        };

                        // Add proxy to handle style properties
                        finalValue = new Proxy(finalValue, {
                            get: function (target, prop) {
                                if (prop in target) return target[prop];
                                if (target._element.style[prop] !== undefined) return target._element.style[prop];
                                return undefined;
                            },
                            set: function (target, prop, value) {
                                if (prop in target) {
                                    target[prop] = value;
                                    return true;
                                }
                                target._element.style[prop] = value;
                                return true;
                            }
                        });

                        neoteVariables[varName] = finalValue;
                        updateVariableViewer();
                        continue;
                    }

                    // Handle button assignment
                    let matchButtonAssign = rawValue.match(/^button\s*\((.*)\)/);
                    if (matchButtonAssign) {
                        const args = matchButtonAssign[1].split(',').map(s => s.trim());
                        const buttonText = interpolateString(args[0]);
                        const buttonAction = args.length > 1 ? args[1].trim() : 'noAction';

                        const buttonElement = document.createElement('button');
                        buttonElement.className = 'neote-button';
                        buttonElement.style.backgroundColor = 'var(--highlight-purple)';
                        buttonElement.style.marginTop = '8px';
                        buttonElement.textContent = buttonText.replace(/^"|"$/g, '');

                        if (buttonAction === 'report()') {
                            buttonElement.onclick = () => {
                                modal.classList.remove('hidden');
                                showModal("Neote Report Dialog (report())", `A report action was triggered by button: "${buttonText.replace(/^"|"$/g, '')}".`);
                            };
                        } else if (neoteFunctions[buttonAction]) {
                            buttonElement.onclick = () => callFunction(buttonAction);
                        } else {
                            buttonElement.onclick = () => displayOutput(`[Button]: '${buttonText.replace(/^"|"$/g, '')}' clicked. No callable function provided or action is unrecognized.`);
                        }

                        outputPanel.appendChild(buttonElement);
                        outputPanel.scrollTop = outputPanel.scrollHeight;

                        // Create wrapper object
                        finalValue = {
                            _element: buttonElement,
                            _type: 'button',
                            delete: function () { this._element.remove(); },
                            get text() { return this._element.textContent; },
                            set text(val) { this._element.textContent = val; }
                        };

                        finalValue = new Proxy(finalValue, {
                            get: function (target, prop) {
                                if (prop in target) return target[prop];
                                if (target._element.style[prop] !== undefined) return target._element.style[prop];
                                return undefined;
                            },
                            set: function (target, prop, value) {
                                if (prop in target) {
                                    target[prop] = value;
                                    return true;
                                }
                                target._element.style[prop] = value;
                                return true;
                            }
                        });

                        neoteVariables[varName] = finalValue;
                        updateVariableViewer();
                        continue;
                    }

                    // Handle loop().value syntax
                    if (rawValue.match(/^loop\s*\((\d+)\)\.value$/)) {
                        const loopMatch = rawValue.match(/^loop\s*\((\d+)\)\.value$/);
                        const iterations = parseInt(loopMatch[1]);
                        finalValue = iterations - 1;
                        neoteVariables[varName] = finalValue;
                        updateVariableViewer();
                        continue;
                    }

                    // Handle math functions
                    const mathMatch = rawValue.match(/^(random|round|floor|ceil|abs|sqrt|pow|sin|cos|tan|min|max|log|exp|pi|e)\((.*)\)$/);
                    if (mathMatch) {
                        const mathFunc = mathMatch[1];
                        const mathArgs = mathMatch[2];

                        if (!neoteMathEnabled[mathFunc]) {
                            displayOutput(`RUNTIME ERROR: Math function '${mathFunc}' not imported. Add '$attach, @neoteMath take ${mathFunc};' or 'take *;'`, true);
                            continue;
                        }

                        try {
                            const resolveArg = (arg) => {
                                arg = arg.trim();
                                if (neoteVariables.hasOwnProperty(arg)) {
                                    return parseFloat(neoteVariables[arg]);
                                }
                                return parseFloat(arg);
                            };

                            if (mathFunc === 'random') {
                                const args = mathArgs.split(',').map(resolveArg);
                                finalValue = args.length === 2 ? Math.random() * (args[1] - args[0]) + args[0] : Math.random();
                            } else if (mathFunc === 'round') {
                                finalValue = Math.round(resolveArg(mathArgs));
                            } else if (mathFunc === 'floor') {
                                finalValue = Math.floor(resolveArg(mathArgs));
                            } else if (mathFunc === 'ceil') {
                                finalValue = Math.ceil(resolveArg(mathArgs));
                            } else if (mathFunc === 'abs') {
                                finalValue = Math.abs(resolveArg(mathArgs));
                            } else if (mathFunc === 'sqrt') {
                                finalValue = Math.sqrt(resolveArg(mathArgs));
                            } else if (mathFunc === 'pow') {
                                const args = mathArgs.split(',').map(resolveArg);
                                finalValue = Math.pow(args[0], args[1]);
                            } else if (mathFunc === 'sin') {
                                finalValue = Math.sin(resolveArg(mathArgs));
                            } else if (mathFunc === 'cos') {
                                finalValue = Math.cos(resolveArg(mathArgs));
                            } else if (mathFunc === 'tan') {
                                finalValue = Math.tan(resolveArg(mathArgs));
                            } else if (mathFunc === 'min') {
                                const args = mathArgs.split(',').map(resolveArg);
                                finalValue = Math.min(...args);
                            } else if (mathFunc === 'max') {
                                const args = mathArgs.split(',').map(resolveArg);
                                finalValue = Math.max(...args);
                            } else if (mathFunc === 'log') {
                                finalValue = Math.log(resolveArg(mathArgs));
                            } else if (mathFunc === 'exp') {
                                finalValue = Math.exp(resolveArg(mathArgs));
                            }
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Math function '${mathFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle pi and e constants
                    if (rawValue === 'pi()' && neoteMathEnabled['pi']) {
                        finalValue = Math.PI;
                        neoteVariables[varName] = finalValue;
                        updateVariableViewer();
                        continue;
                    } else if (rawValue === 'e()' && neoteMathEnabled['e']) {
                        finalValue = Math.E;
                        neoteVariables[varName] = finalValue;
                        updateVariableViewer();
                        continue;
                    } else if ((rawValue === 'pi()' || rawValue === 'e()') && !neoteMathEnabled[rawValue.replace('()', '')]) {
                        displayOutput(`RUNTIME ERROR: Math constant '${rawValue.replace('()', '')}' not imported. Add '$attach, @neoteMath take ${rawValue.replace('()', '')};'`, true);
                        continue;
                    }

                    // Handle array functions that return values
                    const arrayMatch = rawValue.match(/^(length|join|includes|indexOf|slice)\((.*)\)$/);
                    if (arrayMatch) {
                        const arrayFunc = arrayMatch[1];
                        const arrayArgs = arrayMatch[2];

                        if (!neoteArrayEnabled[arrayFunc]) {
                            displayOutput(`RUNTIME ERROR: Array function '${arrayFunc}' not imported. Add '$attach, @neoteArray take ${arrayFunc};'`, true);
                            continue;
                        }

                        try {
                            const args = arrayArgs.split(',').map(a => a.trim());
                            const arrName = args[0];

                            if (!neoteVariables[arrName] || !Array.isArray(neoteVariables[arrName])) {
                                displayOutput(`RUNTIME ERROR: '${arrName}' is not an array`, true);
                                continue;
                            }

                            const arr = neoteVariables[arrName];

                            if (arrayFunc === 'length') {
                                finalValue = arr.length;
                            } else if (arrayFunc === 'join') {
                                const separator = args[1] ? args[1].replace(/^"|"$/g, '') : ',';
                                finalValue = arr.join(separator);
                            } else if (arrayFunc === 'includes') {
                                const searchValue = args[1] ? (neoteVariables[args[1]] !== undefined ? neoteVariables[args[1]] : args[1].replace(/^"|"$/g, '')) : null;
                                finalValue = arr.includes(searchValue);
                            } else if (arrayFunc === 'indexOf') {
                                const searchValue = args[1] ? (neoteVariables[args[1]] !== undefined ? neoteVariables[args[1]] : args[1].replace(/^"|"$/g, '')) : null;
                                finalValue = arr.indexOf(searchValue);
                            } else if (arrayFunc === 'slice') {
                                const start = args[1] ? parseInt(args[1]) : 0;
                                const end = args[2] ? parseInt(args[2]) : arr.length;
                                finalValue = arr.slice(start, end);
                            }

                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Array function '${arrayFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle DB functions that return values
                    const dbMatch = rawValue.match(/^db\.(get|getAll|query|count)\((.*)\)$/);
                    if (dbMatch) {
                        const dbFunc = dbMatch[1];
                        const dbArgs = dbMatch[2];

                        if (!neoteDBEnabled[dbFunc]) {
                            displayOutput(`RUNTIME ERROR: DB function '${dbFunc}' not imported. Add '$attach, @neoteDB take ${dbFunc};'`, true);
                            continue;
                        }

                        try {
                            const args = dbArgs.split(',').map(a => a.trim());
                            const tableName = args[0].replace(/^"|"$/g, '');

                            if (!neoteDB[tableName]) {
                                displayOutput(`RUNTIME ERROR: Table '${tableName}' does not exist`, true);
                                continue;
                            }

                            if (dbFunc === 'get') {
                                const id = args[1] ? (neoteVariables[args[1]] !== undefined ? neoteVariables[args[1]] : JSON.parse(args[1])) : null;
                                const record = neoteDB[tableName].find(r => r.id === id);
                                finalValue = record || null;
                            } else if (dbFunc === 'getAll') {
                                finalValue = neoteDB[tableName];
                            } else if (dbFunc === 'query') {
                                const field = args[1].replace(/^"|"$/g, '');
                                const value = args[2] ? args[2].replace(/^"|"$/g, '') : null;
                                finalValue = neoteDB[tableName].filter(r => r[field] == value);
                            } else if (dbFunc === 'count') {
                                finalValue = neoteDB[tableName].length;
                            }

                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: DB function '${dbFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle geo functions that return values
                    const geoMatch = rawValue.match(/^geo\.(distance|getLocation|geocode)\((.*)\)$/);
                    if (geoMatch) {
                        const geoFunc = geoMatch[1];
                        const geoArgs = geoMatch[2];

                        if (!neoteGeoEnabled[geoFunc]) {
                            displayOutput(`RUNTIME ERROR: Geo function '${geoFunc}' not imported. Add '$attach, @neoteGeo take ${geoFunc};'`, true);
                            continue;
                        }

                        try {
                            if (geoFunc === 'distance') {
                                const args = geoArgs.split(',').map(a => {
                                    const trimmed = a.trim();
                                    return neoteVariables[trimmed] !== undefined ? parseFloat(neoteVariables[trimmed]) : parseFloat(trimmed);
                                });
                                const [lat1, lon1, lat2, lon2] = args;
                                const R = 6371;
                                const dLat = (lat2 - lat1) * Math.PI / 180;
                                const dLon = (lon2 - lon1) * Math.PI / 180;
                                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                finalValue = R * c;
                            }
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Geo function '${geoFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle HTTP functions
                    const httpMatch = rawValue.match(/^http\.(get|post|put|delete)\((.*)\)$/);
                    if (httpMatch) {
                        const httpFunc = httpMatch[1];
                        const httpArgs = httpMatch[2];

                        if (!neoteHTTPEnabled[httpFunc]) {
                            displayOutput(`RUNTIME ERROR: HTTP function '${httpFunc}' not imported. Add '$attach, @neoteHTTP take ${httpFunc};'`, true);
                            continue;
                        }

                        try {
                            const args = [];
                            let current = '';
                            let depth = 0;
                            for (let char of httpArgs) {
                                if (char === '{' || char === '[') depth++;
                                if (char === '}' || char === ']') depth--;
                                if (char === ',' && depth === 0) {
                                    args.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            if (current) args.push(current.trim());

                            const url = args[0] ? interpolateString(args[0]) : '';

                            if (httpFunc === 'get' || httpFunc === 'delete') {
                                fetch(url, { method: httpFunc.toUpperCase() })
                                    .then(res => res.json())
                                    .then(data => {
                                        neoteVariables[varName] = data;
                                        updateVariableViewer();
                                        writeToTerminal(`HTTP: ${httpFunc.toUpperCase()} request to ${url} completed`, 'log');
                                    })
                                    .catch(err => {
                                        displayOutput(`RUNTIME ERROR: HTTP ${httpFunc} failed: ${err.message}`, true);
                                    });
                            } else if (httpFunc === 'post' || httpFunc === 'put') {
                                let body = {};
                                if (args[1]) {
                                    if (neoteVariables[args[1]]) {
                                        body = neoteVariables[args[1]];
                                    } else {
                                        body = JSON.parse(args[1].replace(/'/g, '"').replace(/([a-zA-Z_][a-zA-Z0-9_]*):/g, '"$1":'));
                                    }
                                }
                                fetch(url, {
                                    method: httpFunc.toUpperCase(),
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(body)
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        neoteVariables[varName] = data;
                                        updateVariableViewer();
                                        writeToTerminal(`HTTP: ${httpFunc.toUpperCase()} request to ${url} completed`, 'log');
                                    })
                                    .catch(err => {
                                        displayOutput(`RUNTIME ERROR: HTTP ${httpFunc} failed: ${err.message}`, true);
                                    });
                            }
                            finalValue = null;
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: HTTP function '${httpFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle storage functions
                    const storageMatch = rawValue.match(/^(load|has|keys)\((.*)\)$/);
                    if (storageMatch) {
                        const storageFunc = storageMatch[1];
                        const storageArgs = storageMatch[2];

                        if (!neoteStorageEnabled[storageFunc]) {
                            displayOutput(`RUNTIME ERROR: Storage function '${storageFunc}' not imported. Add '$attach, @neoteStorage take ${storageFunc};'`, true);
                            continue;
                        }

                        try {
                            if (storageFunc === 'load') {
                                const key = storageArgs.replace(/^"|"$/g, '');
                                const stored = localStorage.getItem(`neote_storage_${key}`);
                                finalValue = stored ? JSON.parse(stored) : null;
                            } else if (storageFunc === 'has') {
                                const key = storageArgs.replace(/^"|"$/g, '');
                                finalValue = localStorage.getItem(`neote_storage_${key}`) !== null;
                            } else if (storageFunc === 'keys') {
                                const allKeys = [];
                                for (let i = 0; i < localStorage.length; i++) {
                                    const key = localStorage.key(i);
                                    if (key && key.startsWith('neote_storage_')) {
                                        allKeys.push(key.replace('neote_storage_', ''));
                                    }
                                }
                                finalValue = allKeys;
                            }
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Storage function '${storageFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle time functions
                    const timeMatch = rawValue.match(/^(timestamp|getDate|getTime|getYear|getMonth|getDay|getHour|getMinute|getSecond|getDayName)\(\)$/);
                    if (timeMatch) {
                        const timeFunc = timeMatch[1];

                        if (!neoteTimeEnabled[timeFunc]) {
                            displayOutput(`RUNTIME ERROR: Time function '${timeFunc}' not imported. Add '$attach, @neoteTime take ${timeFunc};'`, true);
                            continue;
                        }

                        try {
                            const now = new Date();
                            if (timeFunc === 'timestamp') {
                                finalValue = now.getTime();
                            } else if (timeFunc === 'getDate') {
                                finalValue = now.toISOString().split('T')[0];
                            } else if (timeFunc === 'getTime') {
                                finalValue = now.toTimeString().split(' ')[0];
                            } else if (timeFunc === 'getYear') {
                                finalValue = now.getFullYear();
                            } else if (timeFunc === 'getMonth') {
                                finalValue = now.getMonth() + 1;
                            } else if (timeFunc === 'getDay') {
                                finalValue = now.getDate();
                            } else if (timeFunc === 'getHour') {
                                finalValue = now.getHours();
                            } else if (timeFunc === 'getMinute') {
                                finalValue = now.getMinutes();
                            } else if (timeFunc === 'getSecond') {
                                finalValue = now.getSeconds();
                            } else if (timeFunc === 'getDayName') {
                                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                                finalValue = days[now.getDay()];
                            }
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Time function '${timeFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle regex functions
                    const regexMatch = rawValue.match(/^regex\.(match|test|replace|split|extract)\((.*)\)$/);
                    if (regexMatch) {
                        const regexFunc = regexMatch[1];
                        const regexArgs = regexMatch[2];

                        if (!neoteRegexEnabled[regexFunc]) {
                            displayOutput(`RUNTIME ERROR: Regex function '${regexFunc}' not imported. Add '$attach, @neoteRegex take ${regexFunc};'`, true);
                            continue;
                        }

                        try {
                            const args = [];
                            let current = '';
                            let inQuotes = false;
                            for (let char of regexArgs) {
                                if (char === '"') inQuotes = !inQuotes;
                                if (char === ',' && !inQuotes) {
                                    args.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            if (current) args.push(current.trim());

                            const text = args[0] ? (neoteVariables[args[0]] !== undefined ? String(neoteVariables[args[0]]) : args[0].replace(/^"|"$/g, '')) : '';
                            const pattern = args[1] ? args[1].replace(/^"|"$/g, '') : '';
                            const regex = new RegExp(pattern, 'g');

                            if (regexFunc === 'match') {
                                finalValue = text.match(regex);
                            } else if (regexFunc === 'test') {
                                finalValue = regex.test(text);
                            } else if (regexFunc === 'replace') {
                                const replacement = args[2] ? args[2].replace(/^"|"$/g, '') : '';
                                finalValue = text.replace(regex, replacement);
                            } else if (regexFunc === 'split') {
                                finalValue = text.split(regex);
                            } else if (regexFunc === 'extract') {
                                const matches = [];
                                let match;
                                while ((match = regex.exec(text)) !== null) {
                                    matches.push(match[0]);
                                }
                                finalValue = matches;
                            }
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Regex function '${regexFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    // Handle format functions
                    const formatMatch = rawValue.match(/^format\.(currency|number|date|fileSize|percentage|capitalize)\((.*)\)$/);
                    if (formatMatch) {
                        const formatFunc = formatMatch[1];
                        const formatArgs = formatMatch[2];

                        if (!neoteFormatEnabled[formatFunc]) {
                            displayOutput(`RUNTIME ERROR: Format function '${formatFunc}' not imported. Add '$attach, @neoteFormat take ${formatFunc};'`, true);
                            continue;
                        }

                        try {
                            const args = [];
                            let current = '';
                            let inQuotes = false;
                            for (let char of formatArgs) {
                                if (char === '"') inQuotes = !inQuotes;
                                if (char === ',' && !inQuotes) {
                                    args.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            if (current) args.push(current.trim());

                            if (formatFunc === 'currency') {
                                const value = args[0] ? (neoteVariables[args[0]] !== undefined ? parseFloat(neoteVariables[args[0]]) : parseFloat(args[0])) : 0;
                                const currency = args[1] ? args[1].replace(/^"|"$/g, '') : 'USD';
                                finalValue = new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(value);
                            } else if (formatFunc === 'number') {
                                const value = args[0] ? (neoteVariables[args[0]] !== undefined ? parseFloat(neoteVariables[args[0]]) : parseFloat(args[0])) : 0;
                                const decimals = args[1] ? parseInt(args[1]) : 2;
                                finalValue = value.toFixed(decimals);
                            } else if (formatFunc === 'date') {
                                const timestamp = args[0] ? (neoteVariables[args[0]] !== undefined ? neoteVariables[args[0]] : parseInt(args[0])) : Date.now();
                                const format = args[1] ? args[1].replace(/^"|"$/g, '') : 'YYYY-MM-DD';
                                const date = new Date(timestamp);
                                finalValue = format
                                    .replace('YYYY', date.getFullYear())
                                    .replace('MM', String(date.getMonth() + 1).padStart(2, '0'))
                                    .replace('DD', String(date.getDate()).padStart(2, '0'))
                                    .replace('HH', String(date.getHours()).padStart(2, '0'))
                                    .replace('mm', String(date.getMinutes()).padStart(2, '0'))
                                    .replace('ss', String(date.getSeconds()).padStart(2, '0'));
                            } else if (formatFunc === 'fileSize') {
                                const bytes = args[0] ? (neoteVariables[args[0]] !== undefined ? parseFloat(neoteVariables[args[0]]) : parseFloat(args[0])) : 0;
                                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                                let size = bytes;
                                let unitIndex = 0;
                                while (size >= 1024 && unitIndex < units.length - 1) {
                                    size /= 1024;
                                    unitIndex++;
                                }
                                finalValue = `${size.toFixed(2)} ${units[unitIndex]}`;
                            } else if (formatFunc === 'percentage') {
                                const value = args[0] ? (neoteVariables[args[0]] !== undefined ? parseFloat(neoteVariables[args[0]]) : parseFloat(args[0])) : 0;
                                finalValue = `${(value * 100).toFixed(2)}%`;
                            } else if (formatFunc === 'capitalize') {
                                const text = args[0] ? (neoteVariables[args[0]] !== undefined ? String(neoteVariables[args[0]]) : args[0].replace(/^"|"$/g, '')) : '';
                                finalValue = text.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                            }
                            neoteVariables[varName] = finalValue;
                            updateVariableViewer();
                            continue;
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Format function '${formatFunc}' failed: ${e.message}`, true);
                            continue;
                        }
                    }

                    if (rawValue.startsWith('"') && rawValue.endsWith('"')) {
                        finalValue = interpolateString(rawValue);
                    }
                    else if (rawValue.startsWith('[') && rawValue.endsWith(']')) {
                        try {
                            const arrayContent = rawValue.slice(1, -1).trim();
                            if (arrayContent === '') {
                                finalValue = createNeoteArray([]);
                            } else {
                                const items = arrayContent.split(',').map(item => {
                                    item = item.trim();
                                    if (item.startsWith('"') && item.endsWith('"')) {
                                        return interpolateString(item);
                                    } else {
                                        try {
                                            return Function(`return ${item}`)();
                                        } catch (e) {
                                            return item;
                                        }
                                    }
                                });
                                finalValue = createNeoteArray(items);
                            }
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Failed to parse array: ${e.message}`, true);
                            finalValue = createNeoteArray([]);
                        }
                    }
                    else if (rawValue.startsWith('{') && rawValue.endsWith('}')) {
                        try {
                            const objContent = rawValue.slice(1, -1).trim();
                            if (objContent === '') {
                                finalValue = createNeoteObject({});
                            } else {
                                const pairs = objContent.split(',');
                                const obj = {};

                                for (const pair of pairs) {
                                    const colonIndex = pair.indexOf(':');
                                    if (colonIndex === -1) continue;

                                    const key = pair.substring(0, colonIndex).trim();
                                    let value = pair.substring(colonIndex + 1).trim();

                                    if (value.startsWith('"') && value.endsWith('"')) {
                                        value = interpolateString(value);
                                    } else {
                                        try {
                                            value = Function(`return ${value}`)();
                                        } catch (e) {
                                            value = value;
                                        }
                                    }

                                    obj[key] = value;
                                }

                                finalValue = createNeoteObject(obj);
                            }
                        } catch (e) {
                            displayOutput(`RUNTIME ERROR: Failed to parse object: ${e.message}`, true);
                            finalValue = createNeoteObject({});
                        }
                    }
                    else if (rawValue.startsWith('ovr.improp')) {
                        if (lines === executionQueue) {
                            isRunningImprop = true;
                            executionIndex = i;
                            handleImprop(varName, rawValue);
                            return;
                        } else {
                            displayOutput(`RUNTIME ERROR: 'ovr.improp' is not allowed inside function blocks.`, true);
                            return;
                        }
                    }
                    else {
                        try {
                            finalValue = Function(`return ${rawValue}`)();
                        } catch (e) {
                            finalValue = rawValue;
                        }
                    }
                    neoteVariables[varName] = finalValue;
                    updateVariableViewer();
                    continue;
                }

                // Showcase.warn and showcase.error
                let matchShowcaseWarn = line.match(/^showcase\.warn\s*\((.*)\)/);
                if (matchShowcaseWarn) {
                    const rawContent = matchShowcaseWarn[1].trim();
                    let content;
                    if (rawContent.startsWith('"') && rawContent.endsWith('"')) {
                        content = interpolateString(rawContent);
                    } else {
                        try { content = String(Function(`return ${rawContent}`)()); } catch (e) { content = rawContent; }
                    }

                    const warnElement = document.createElement('div');
                    warnElement.className = 'showcase-output';
                    warnElement.style.cssText = 'background-color: rgba(245, 158, 11, 0.1); padding: 8px 16px; border-radius: 6px; color: var(--accent-yellow); border-left: 4px solid var(--accent-yellow); margin: 4px 0;';
                    warnElement.textContent = `‚ö†Ô∏è ${content}`;
                    outputPanel.appendChild(warnElement);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                let matchShowcaseError = line.match(/^showcase\.error\s*\((.*)\)/);
                if (matchShowcaseError) {
                    const rawContent = matchShowcaseError[1].trim();
                    let content;
                    if (rawContent.startsWith('"') && rawContent.endsWith('"')) {
                        content = interpolateString(rawContent);
                    } else {
                        try { content = String(Function(`return ${rawContent}`)()); } catch (e) { content = rawContent; }
                    }

                    const errorElement = document.createElement('div');
                    errorElement.className = 'showcase-output';
                    errorElement.style.cssText = 'background-color: rgba(239, 68, 68, 0.1); padding: 8px 16px; border-radius: 6px; color: var(--accent-red); border-left: 4px solid var(--accent-red); margin: 4px 0;';
                    errorElement.textContent = `‚ùå ${content}`;
                    outputPanel.appendChild(errorElement);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Showcase output
                let matchShowcase = line.match(/^showcase\s*\((.*)\)(?:\s*\{([^}]*)})?/);
                if (matchShowcase) {
                    const rawContent = matchShowcase[1].trim();
                    const styleBlock = matchShowcase[2] ? matchShowcase[2].trim() : null;
                    let content;

                    if (rawContent.startsWith('"') && rawContent.endsWith('"')) {
                        content = interpolateString(rawContent);
                    } else if (rawContent.includes('.') && !rawContent.includes('(')) {
                        const parts = rawContent.split('.');
                        let value = neoteVariables[parts[0]];
                        for (let i = 1; i < parts.length; i++) {
                            if (value && typeof value === 'object' && value[parts[i]] !== undefined) {
                                value = value[parts[i]];
                            }
                        }
                        content = value !== undefined ? String(value) : rawContent;
                    } else {
                        try { content = String(Function(`return ${rawContent}`)()); } catch (e) { content = rawContent; }
                    }

                    if (styleBlock) {
                        const styles = parseStyleBlock(styleBlock);
                        const styledElement = createStyledElement('div', content, styles);
                        styledElement.className = 'showcase-output';
                        outputPanel.appendChild(styledElement);
                        outputPanel.scrollTop = outputPanel.scrollHeight;
                    } else {
                        const output = document.createElement('div');
                        output.className = 'showcase-output';
                        output.textContent = content;
                        outputPanel.appendChild(output);
                        outputPanel.scrollTop = outputPanel.scrollHeight;
                    }
                    continue;
                }

                // Notification
                let matchCove = line.match(/^ovr\.cove\s*\((.*)\)/);
                if (matchCove) {
                    const rawMessage = matchCove[1].trim();
                    const message = interpolateString(rawMessage);

                    modal.classList.remove('hidden');
                    showModal("Neote Notification (ovr.cove)", message, false);
                    continue;
                }

                // Notify commands
                let matchNotify = line.match(/^notify\.(success|error|warning|info)\s*\((.*)\)/);
                if (matchNotify) {
                    const notifyType = matchNotify[1];
                    const rawMessage = matchNotify[2].trim();

                    if (!neoteNotifyEnabled[notifyType]) {
                        displayOutput(`RUNTIME ERROR: Notify function '${notifyType}' not imported. Add '$attach, @neoteNotify take ${notifyType};'`, true);
                        continue;
                    }

                    const message = interpolateString(rawMessage);

                    const notifyElement = document.createElement('div');
                    notifyElement.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px; max-width: 300px;';

                    if (notifyType === 'success') {
                        notifyElement.style.backgroundColor = 'var(--accent-green)';
                        notifyElement.style.color = 'white';
                        notifyElement.innerHTML = `‚úì ${message}`;
                    } else if (notifyType === 'error') {
                        notifyElement.style.backgroundColor = 'var(--accent-red)';
                        notifyElement.style.color = 'white';
                        notifyElement.innerHTML = `‚úó ${message}`;
                    } else if (notifyType === 'warning') {
                        notifyElement.style.backgroundColor = 'var(--accent-yellow)';
                        notifyElement.style.color = 'white';
                        notifyElement.innerHTML = `‚ö† ${message}`;
                    } else if (notifyType === 'info') {
                        notifyElement.style.backgroundColor = 'var(--accent-blue)';
                        notifyElement.style.color = 'white';
                        notifyElement.innerHTML = `‚Ñπ ${message}`;
                    }

                    document.body.appendChild(notifyElement);

                    setTimeout(() => {
                        notifyElement.remove();
                    }, 3000);

                    writeToTerminal(`Notify: ${notifyType} - ${message}`, 'log');
                    continue;
                }

                // DOM commands
                let matchDOM = line.match(/^dom\.(create|setText|setHTML|setStyle|addClass|removeClass|remove|show|hide)\s*\((.*)\)/);
                if (matchDOM) {
                    const domFunc = matchDOM[1];
                    const domArgs = matchDOM[2].trim();

                    if (!neoteDOMEnabled[domFunc]) {
                        displayOutput(`RUNTIME ERROR: DOM function '${domFunc}' not imported. Add '$attach, @neoteDOM take ${domFunc};'`, true);
                        continue;
                    }

                    try {
                        const args = [];
                        let current = '';
                        let inQuotes = false;
                        for (let char of domArgs) {
                            if (char === '"') inQuotes = !inQuotes;
                            if (char === ',' && !inQuotes) {
                                args.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        if (current) args.push(current.trim());

                        if (domFunc === 'create') {
                            const tagName = args[0] ? args[0].replace(/^"|"$/g, '') : 'div';
                            const elementId = args[1] ? args[1].replace(/^"|"$/g, '') : `neote-el-${Date.now()}`;

                            const element = document.createElement(tagName);
                            element.id = elementId;
                            element.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 12px; border-radius: 8px; margin: 8px 0; color: white;';

                            outputPanel.appendChild(element);
                            neoteDOMElements[elementId] = element;
                            writeToTerminal(`DOM: Created ${tagName} with id '${elementId}'`, 'log');
                        } else if (domFunc === 'setText') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';
                            const text = args[1] ? interpolateString(args[1]) : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].textContent = text;
                                writeToTerminal(`DOM: Set text for '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'setHTML') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';
                            const html = args[1] ? interpolateString(args[1]) : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].innerHTML = html;
                                writeToTerminal(`DOM: Set HTML for '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'setStyle') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';
                            const property = args[1] ? args[1].replace(/^"|"$/g, '') : '';
                            const value = args[2] ? args[2].replace(/^"|"$/g, '') : '';

                            if (neoteDOMElements[elementId]) {
                                const camelProperty = property.replace(/-([a-z])/g, (m, l) => l.toUpperCase());
                                neoteDOMElements[elementId].style[camelProperty] = value;
                                writeToTerminal(`DOM: Set style ${property} for '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'addClass') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';
                            const className = args[1] ? args[1].replace(/^"|"$/g, '') : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].classList.add(className);
                                writeToTerminal(`DOM: Added class '${className}' to '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'removeClass') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';
                            const className = args[1] ? args[1].replace(/^"|"$/g, '') : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].classList.remove(className);
                                writeToTerminal(`DOM: Removed class '${className}' from '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'remove') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].remove();
                                delete neoteDOMElements[elementId];
                                writeToTerminal(`DOM: Removed element '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'show') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].style.display = 'block';
                                writeToTerminal(`DOM: Showed element '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        } else if (domFunc === 'hide') {
                            const elementId = args[0] ? args[0].replace(/^"|"$/g, '') : '';

                            if (neoteDOMElements[elementId]) {
                                neoteDOMElements[elementId].style.display = 'none';
                                writeToTerminal(`DOM: Hid element '${elementId}'`, 'log');
                            } else {
                                displayOutput(`RUNTIME ERROR: Element '${elementId}' not found`, true);
                            }
                        }
                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: DOM operation '${domFunc}' failed: ${e.message}`, true);
                    }
                    continue;
                }

                // Button
                let matchButton = line.match(/^button\s*\((.*)\)/);
                if (matchButton) {
                    const args = matchButton[1].split(',').map(s => s.trim());
                    const buttonText = interpolateString(args[0]);
                    const buttonAction = args.length > 1 ? args[1].trim() : 'noAction';

                    const buttonElement = document.createElement('button');
                    buttonElement.className = 'neote-button';
                    buttonElement.style.backgroundColor = 'var(--highlight-purple)';
                    buttonElement.style.marginTop = '8px';
                    buttonElement.textContent = buttonText.replace(/^"|"$/g, '');

                    if (buttonAction === 'report()') {
                        buttonElement.onclick = () => {
                            modal.classList.remove('hidden');
                            showModal("Neote Report Dialog (report())", `A report action was triggered by button: "${buttonText.replace(/^"|"$/g, '')}".`);
                        };
                    } else if (neoteFunctions[buttonAction]) {
                        buttonElement.onclick = () => callFunction(buttonAction);
                    } else {
                        buttonElement.onclick = () => displayOutput(`[Button]: '${buttonText.replace(/^"|"$/g, '')}' clicked. No callable function provided or action is unrecognized.`);
                    }

                    outputPanel.appendChild(buttonElement);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Checkbox
                let matchCheckbox = line.match(/^checkbox\s*\((.*)\)/);
                if (matchCheckbox) {
                    const args = matchCheckbox[1].split(',').map(s => s.trim());
                    const varName = args[0].replace(/^"|"$/g, '');
                    const label = args.length > 1 ? interpolateString(args[1]) : 'Checkbox';

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; margin: 8px 0; display: flex; align-items: center;';

                    const checkboxElement = document.createElement('input');
                    checkboxElement.type = 'checkbox';
                    checkboxElement.style.cssText = 'margin-right: 8px; cursor: pointer;';
                    checkboxElement.onchange = () => {
                        neoteVariables[varName] = checkboxElement.checked;
                        updateVariableViewer();
                    };

                    const labelElement = document.createElement('label');
                    labelElement.textContent = label.replace(/^"|"$/g, '');
                    labelElement.style.cssText = 'color: white; cursor: pointer;';
                    labelElement.onclick = () => checkboxElement.click();

                    checkboxContainer.appendChild(checkboxElement);
                    checkboxContainer.appendChild(labelElement);
                    outputPanel.appendChild(checkboxContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Select dropdown
                let matchSelect = line.match(/^select\s*\((.*)\)/);
                if (matchSelect) {
                    const args = matchSelect[1].split(',').map(s => s.trim());
                    const varName = args[0].replace(/^"|"$/g, '');
                    const optionsStr = args.slice(1).join(',');
                    const optionsMatch = optionsStr.match(/\[(.+)\]/);

                    if (optionsMatch) {
                        const options = optionsMatch[1].split(',').map(o => o.trim().replace(/^"|"$/g, ''));

                        const selectContainer = document.createElement('div');
                        selectContainer.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; margin: 8px 0;';

                        const selectElement = document.createElement('select');
                        selectElement.style.cssText = 'width: 100%; padding: 8px; background-color: var(--bg-code); color: white; border: 1px solid var(--border-color); border-radius: 4px;';

                        options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            selectElement.appendChild(option);
                        });

                        selectElement.onchange = () => {
                            neoteVariables[varName] = selectElement.value;
                            updateVariableViewer();
                        };

                        selectContainer.appendChild(selectElement);
                        outputPanel.appendChild(selectContainer);
                        outputPanel.scrollTop = outputPanel.scrollHeight;
                    }
                    continue;
                }

                // Slider
                let matchSlider = line.match(/^slider\s*\((.*)\)/);
                if (matchSlider) {
                    const args = matchSlider[1].split(',').map(s => s.trim());
                    const varName = args[0].replace(/^"|"$/g, '');
                    const min = args.length > 1 ? parseFloat(args[1]) : 0;
                    const max = args.length > 2 ? parseFloat(args[2]) : 100;

                    const sliderContainer = document.createElement('div');
                    sliderContainer.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; margin: 8px 0;';

                    const sliderElement = document.createElement('input');
                    sliderElement.type = 'range';
                    sliderElement.min = min;
                    sliderElement.max = max;
                    sliderElement.value = min;
                    sliderElement.style.cssText = 'width: 100%;';

                    const valueDisplay = document.createElement('div');
                    valueDisplay.textContent = `Value: ${min}`;
                    valueDisplay.style.cssText = 'color: white; margin-top: 4px; font-size: 12px;';

                    sliderElement.oninput = () => {
                        neoteVariables[varName] = parseFloat(sliderElement.value);
                        valueDisplay.textContent = `Value: ${sliderElement.value}`;
                        updateVariableViewer();
                    };

                    sliderContainer.appendChild(sliderElement);
                    sliderContainer.appendChild(valueDisplay);
                    outputPanel.appendChild(sliderContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Textarea
                let matchTextarea = line.match(/^textarea\s*\((.*)\)/);
                if (matchTextarea) {
                    const args = matchTextarea[1].split(',').map(s => s.trim());
                    const varName = args[0].replace(/^"|"$/g, '');
                    const placeholder = args.length > 1 ? interpolateString(args[1]) : 'Enter text';

                    const textareaContainer = document.createElement('div');
                    textareaContainer.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; margin: 8px 0;';

                    const textareaElement = document.createElement('textarea');
                    textareaElement.placeholder = placeholder.replace(/^"|"$/g, '');
                    textareaElement.rows = 4;
                    textareaElement.style.cssText = 'width: 100%; padding: 8px; background-color: var(--bg-code); color: white; border: 1px solid var(--border-color); border-radius: 4px; resize: vertical;';
                    textareaElement.onchange = () => {
                        neoteVariables[varName] = textareaElement.value;
                        updateVariableViewer();
                    };

                    textareaContainer.appendChild(textareaElement);
                    outputPanel.appendChild(textareaContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Progress bar
                let matchProgress = line.match(/^progress\s*\((.*)\)/);
                if (matchProgress) {
                    const args = matchProgress[1].split(',').map(s => s.trim());
                    const value = parseFloat(args[0]) || 0;
                    const max = args.length > 1 ? parseFloat(args[1]) : 100;
                    const percentage = (value / max) * 100;

                    const progressContainer = document.createElement('div');
                    progressContainer.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; margin: 8px 0;';

                    const progressBar = document.createElement('div');
                    progressBar.style.cssText = 'width: 100%; height: 20px; background-color: var(--bg-code); border-radius: 4px; overflow: hidden;';

                    const progressFill = document.createElement('div');
                    progressFill.style.cssText = `width: ${percentage}%; height: 100%; background-color: var(--highlight-purple); transition: width 0.3s;`;

                    const progressText = document.createElement('div');
                    progressText.textContent = `${value} / ${max} (${percentage.toFixed(1)}%)`;
                    progressText.style.cssText = 'color: white; margin-top: 4px; font-size: 12px;';

                    progressBar.appendChild(progressFill);
                    progressContainer.appendChild(progressBar);
                    progressContainer.appendChild(progressText);
                    outputPanel.appendChild(progressContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Divider
                let matchDivider = line.match(/^divider\s*\((.*)\)?/);
                if (matchDivider || line.trim() === 'divider()') {
                    const label = matchDivider && matchDivider[1] ? interpolateString(matchDivider[1]) : null;

                    const dividerContainer = document.createElement('div');
                    dividerContainer.style.cssText = 'margin: 16px 0; display: flex; align-items: center;';

                    if (label) {
                        const dividerLine1 = document.createElement('div');
                        dividerLine1.style.cssText = 'flex: 1; height: 1px; background-color: var(--border-color);';

                        const dividerText = document.createElement('span');
                        dividerText.textContent = label.replace(/^"|"$/g, '');
                        dividerText.style.cssText = 'color: var(--text-secondary); padding: 0 12px; font-size: 12px;';

                        const dividerLine2 = document.createElement('div');
                        dividerLine2.style.cssText = 'flex: 1; height: 1px; background-color: var(--border-color);';

                        dividerContainer.appendChild(dividerLine1);
                        dividerContainer.appendChild(dividerText);
                        dividerContainer.appendChild(dividerLine2);
                    } else {
                        const dividerLine = document.createElement('div');
                        dividerLine.style.cssText = 'width: 100%; height: 1px; background-color: var(--border-color);';
                        dividerContainer.appendChild(dividerLine);
                    }

                    outputPanel.appendChild(dividerContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Heading
                let matchHeading = line.match(/^heading\s*\((.*)\)/);
                if (matchHeading) {
                    const args = matchHeading[1].split(',').map(s => s.trim());
                    const text = interpolateString(args[0]);
                    const level = args.length > 1 ? parseInt(args[1]) : 1;

                    const headingElement = document.createElement(`h${Math.min(Math.max(level, 1), 6)}`);
                    headingElement.textContent = text.replace(/^"|"$/g, '');
                    headingElement.style.cssText = 'color: white; margin: 12px 0;';

                    outputPanel.appendChild(headingElement);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Link
                let matchLink = line.match(/^link\s*\((.*)\)/);
                if (matchLink) {
                    const args = matchLink[1].split(',').map(s => s.trim());
                    const text = interpolateString(args[0]);
                    const url = args.length > 1 ? interpolateString(args[1]) : '#';

                    const linkElement = document.createElement('a');
                    linkElement.textContent = text.replace(/^"|"$/g, '');
                    linkElement.href = url.replace(/^"|"$/g, '');
                    linkElement.target = '_blank';
                    linkElement.style.cssText = 'color: var(--highlight-purple-light); text-decoration: underline; cursor: pointer; display: block; margin: 4px 0;';

                    outputPanel.appendChild(linkElement);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Input
                let matchInput = line.match(/^input\s*\((.*)\)/);
                if (matchInput) {
                    const args = matchInput[1].split(',').map(s => s.trim());
                    const varName = args[0].replace(/^"|"$/g, '');
                    const placeholder = args.length > 1 ? interpolateString(args[1]) : 'Enter value';

                    const inputContainer = document.createElement('div');
                    inputContainer.style.backgroundColor = 'var(--bg-tertiary)';
                    inputContainer.style.border = '1px solid var(--border-color)';
                    inputContainer.style.padding = '8px';
                    inputContainer.style.borderRadius = '8px';
                    inputContainer.style.margin = '8px 0';

                    const inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.placeholder = placeholder.replace(/^"|"$/g, '');
                    inputElement.style.width = '100%';
                    inputElement.style.padding = '8px';
                    inputElement.style.backgroundColor = 'var(--bg-code)';
                    inputElement.style.color = 'white';
                    inputElement.style.border = '1px solid var(--border-color)';
                    inputElement.style.borderRadius = '4px';
                    inputElement.onchange = () => {
                        neoteVariables[varName] = inputElement.value;
                        updateVariableViewer();
                    };

                    inputContainer.appendChild(inputElement);
                    outputPanel.appendChild(inputContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Macro expansion
                let matchExpand = line.match(/^expand\s+([a-zA-Z0-9_]+)\s*\((.*)\)/);
                if (matchExpand) {
                    const macroName = matchExpand[1].trim();
                    const argsStr = matchExpand[2].trim();

                    if (!neoteMacros[macroName]) {
                        displayOutput(`RUNTIME ERROR: Macro '${macroName}' not defined.`, true);
                        continue;
                    }

                    const macro = neoteMacros[macroName];
                    const args = argsStr.split(',').map(a => a.trim());

                    if (args.length !== macro.params.length) {
                        displayOutput(`RUNTIME ERROR: Macro '${macroName}' expects ${macro.params.length} arguments, got ${args.length}.`, true);
                        continue;
                    }

                    let expandedCode = macro.body;
                    macro.params.forEach((param, idx) => {
                        const regex = new RegExp(`\\$${param}\\b`, 'g');
                        expandedCode = expandedCode.replace(regex, args[idx]);
                    });

                    writeToTerminal(`Macro: Expanding '${macroName}'...`, 'log');
                    executeLines(expandedCode.split('\n').map(l => l.trim()).filter(l => l));
                    continue;
                }

                // Function call
                let matchCall = line.match(/^call\s+([a-zA-Z0-9_]+)$/);
                if (matchCall) {
                    const funcName = matchCall[1].trim();
                    writeToTerminal(`Call: Executing function '${funcName}'...`, 'log');
                    callFunction(funcName);
                    continue;
                }

                // Extension execution
                let matchExtExecute = line.match(/^ext\.execute\s*\((.*)\)/);
                if (matchExtExecute) {
                    const extId = matchExtExecute[1].trim().replace(/^"|"$/g, '');
                    writeToTerminal(`Extension: Executing '${extId}'...`, 'log');
                    extensionAPI.execute(extId);
                    continue;
                }

                // Extension list
                let matchExtList = line.match(/^ext\.list\s*\(/);
                if (matchExtList) {
                    const exts = extensionAPI.listExtensions();
                    if (exts.length === 0) {
                        displayOutput('No extensions enabled.', false);
                    } else {
                        displayOutput(`Available Extensions (${exts.length}):`, false);
                        exts.forEach((ext, idx) => {
                            displayOutput(`  ${idx + 1}. ${ext.name} - ${ext.description}`, false);
                        });
                    }
                    continue;
                }

                // DB commands
                let matchDB = line.match(/^db\.(create|insert|get|getAll|update|delete|query|drop|count|clear)\s*\((.*)\)/);
                if (matchDB) {
                    const dbFunc = matchDB[1];
                    const dbArgs = matchDB[2].trim();

                    if (!neoteDBEnabled[dbFunc]) {
                        displayOutput(`RUNTIME ERROR: DB function '${dbFunc}' not imported. Add '$attach, @neoteDB take ${dbFunc};'`, true);
                        continue;
                    }

                    try {
                        const args = [];
                        let current = '';
                        let depth = 0;

                        for (let char of dbArgs) {
                            if (char === '{' || char === '[') depth++;
                            if (char === '}' || char === ']') depth--;
                            if (char === ',' && depth === 0) {
                                args.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        if (current) args.push(current.trim());

                        const tableName = args[0] ? args[0].replace(/^"|"$/g, '') : '';

                        if (dbFunc === 'create') {
                            if (!neoteDB[tableName]) {
                                neoteDB[tableName] = [];
                                writeToTerminal(`DB: Table '${tableName}' created`, 'log');
                            } else {
                                writeToTerminal(`DB: Table '${tableName}' already exists`, 'log');
                            }
                        } else if (dbFunc === 'insert') {
                            if (!neoteDB[tableName]) {
                                displayOutput(`RUNTIME ERROR: Table '${tableName}' does not exist`, true);
                                continue;
                            }
                            const dataStr = args[1];
                            let data;
                            if (neoteVariables[dataStr]) {
                                data = neoteVariables[dataStr];
                            } else {
                                data = JSON.parse(dataStr.replace(/'/g, '"').replace(/([a-zA-Z_][a-zA-Z0-9_]*):/g, '"$1":'));
                            }
                            neoteDB[tableName].push(data);
                            writeToTerminal(`DB: Record inserted into '${tableName}'`, 'log');
                        } else if (dbFunc === 'getAll') {
                            if (!neoteDB[tableName]) {
                                displayOutput(`RUNTIME ERROR: Table '${tableName}' does not exist`, true);
                                continue;
                            }
                            const varName = executionQueue[executionIndex].match(/^st\s+([a-zA-Z0-9_]+)\s*=/)?.[1];
                            if (varName) {
                                neoteVariables[varName] = neoteDB[tableName];
                                updateVariableViewer();
                            }
                            writeToTerminal(`DB: Retrieved ${neoteDB[tableName].length} records from '${tableName}'`, 'log');
                        } else if (dbFunc === 'drop') {
                            if (neoteDB[tableName]) {
                                delete neoteDB[tableName];
                                writeToTerminal(`DB: Table '${tableName}' dropped`, 'log');
                            }
                        } else if (dbFunc === 'count') {
                            if (!neoteDB[tableName]) {
                                displayOutput(`RUNTIME ERROR: Table '${tableName}' does not exist`, true);
                                continue;
                            }
                            const varName = executionQueue[executionIndex].match(/^st\s+([a-zA-Z0-9_]+)\s*=/)?.[1];
                            if (varName) {
                                neoteVariables[varName] = neoteDB[tableName].length;
                                updateVariableViewer();
                            }
                        } else if (dbFunc === 'clear') {
                            if (neoteDB[tableName]) {
                                neoteDB[tableName] = [];
                                writeToTerminal(`DB: Table '${tableName}' cleared`, 'log');
                            }
                        }
                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: DB operation failed: ${e.message}`, true);
                    }
                    continue;
                }

                // Geo commands
                let matchGeo = line.match(/^geo\.(distance|getLocation|geocode)\s*\((.*)\)/);
                if (matchGeo) {
                    const geoFunc = matchGeo[1];
                    const geoArgs = matchGeo[2].trim();

                    if (!neoteGeoEnabled[geoFunc]) {
                        displayOutput(`RUNTIME ERROR: Geo function '${geoFunc}' not imported. Add '$attach, @neoteGeo take ${geoFunc};'`, true);
                        continue;
                    }

                    try {
                        if (geoFunc === 'distance') {
                            const args = geoArgs.split(',').map(a => {
                                const trimmed = a.trim();
                                return neoteVariables[trimmed] !== undefined ? parseFloat(neoteVariables[trimmed]) : parseFloat(trimmed);
                            });

                            if (args.length !== 4) {
                                displayOutput(`RUNTIME ERROR: geo.distance requires 4 arguments (lat1, lon1, lat2, lon2)`, true);
                                continue;
                            }

                            const [lat1, lon1, lat2, lon2] = args;
                            const R = 6371;
                            const dLat = (lat2 - lat1) * Math.PI / 180;
                            const dLon = (lon2 - lon1) * Math.PI / 180;
                            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                Math.sin(dLon / 2) * Math.sin(dLon / 2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                            const distance = R * c;

                            const varName = executionQueue[executionIndex].match(/^st\s+([a-zA-Z0-9_]+)\s*=/)?.[1];
                            if (varName) {
                                neoteVariables[varName] = distance;
                                updateVariableViewer();
                            }
                            writeToTerminal(`Geo: Distance calculated: ${distance.toFixed(2)} km`, 'log');
                        } else if (geoFunc === 'getLocation') {
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(
                                    (position) => {
                                        const location = {
                                            latitude: position.coords.latitude,
                                            longitude: position.coords.longitude,
                                            accuracy: position.coords.accuracy
                                        };
                                        const varName = executionQueue[executionIndex].match(/^st\s+([a-zA-Z0-9_]+)\s*=/)?.[1];
                                        if (varName) {
                                            neoteVariables[varName] = location;
                                            updateVariableViewer();
                                        }
                                        writeToTerminal(`Geo: Location retrieved: ${location.latitude}, ${location.longitude}`, 'log');
                                    },
                                    (error) => {
                                        writeToTerminal(`Geo: Location error: ${error.message}`, 'error');
                                    }
                                );
                            } else {
                                displayOutput(`RUNTIME ERROR: Geolocation not supported`, true);
                            }
                        } else if (geoFunc === 'geocode') {
                            writeToTerminal(`Geo: Geocoding requires external API (simulated)`, 'log');
                            const varName = executionQueue[executionIndex].match(/^st\s+([a-zA-Z0-9_]+)\s*=/)?.[1];
                            if (varName) {
                                neoteVariables[varName] = { latitude: 0, longitude: 0, address: geoArgs.replace(/^"|"$/g, '') };
                                updateVariableViewer();
                            }
                        }
                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: Geo operation failed: ${e.message}`, true);
                    }
                    continue;
                }

                // Chart commands
                let matchChart = line.match(/^chart\.(bar|line|pie|doughnut|radar|polarArea)\s*\((.*)\)/);
                if (matchChart) {
                    const chartType = matchChart[1];
                    const argsStr = matchChart[2].trim();

                    if (!neoteChartEnabled[chartType]) {
                        displayOutput(`RUNTIME ERROR: Chart type '${chartType}' not imported. Add '$attach, @neoteChart take ${chartType};'`, true);
                        continue;
                    }

                    try {
                        const args = [];
                        let current = '';
                        let depth = 0;

                        for (let char of argsStr) {
                            if (char === '[' || char === '{') depth++;
                            if (char === ']' || char === '}') depth--;
                            if (char === ',' && depth === 0) {
                                args.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        if (current) args.push(current.trim());

                        const dataArg = args[0];
                        const labelsArg = args[1] || '[]';
                        const titleArg = args[2] || '"Chart"';

                        let data, labels, title;

                        if (neoteVariables[dataArg]) {
                            data = neoteVariables[dataArg];
                        } else {
                            data = JSON.parse(dataArg.replace(/'/g, '"'));
                        }

                        if (neoteVariables[labelsArg]) {
                            labels = neoteVariables[labelsArg];
                        } else {
                            labels = JSON.parse(labelsArg.replace(/'/g, '"'));
                        }

                        title = interpolateString(titleArg);

                        const chartId = `neote-chart-${chartCounter++}`;
                        const chartContainer = document.createElement('div');
                        chartContainer.style.cssText = 'background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 16px; border-radius: 8px; margin: 8px 0;';

                        const canvas = document.createElement('canvas');
                        canvas.id = chartId;
                        canvas.style.maxHeight = '400px';
                        chartContainer.appendChild(canvas);

                        outputPanel.appendChild(chartContainer);
                        outputPanel.scrollTop = outputPanel.scrollHeight;

                        requestAnimationFrame(() => {
                            const colors = [
                                'rgba(147, 51, 234, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(196, 181, 253, 0.8)',
                                'rgba(237, 233, 254, 0.8)',
                                'rgba(221, 214, 254, 0.8)',
                                'rgba(167, 139, 250, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ];

                            const borderColors = colors.map(c => c.replace('0.8', '1'));

                            const ctx = canvas.getContext('2d');

                            const chartConfig = {
                                type: chartType === 'polarArea' ? 'polarArea' : chartType,
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: title,
                                        data: data,
                                        backgroundColor: chartType === 'line' ? 'rgba(147, 51, 234, 0.2)' : colors,
                                        borderColor: chartType === 'line' ? 'rgba(147, 51, 234, 1)' : borderColors,
                                        borderWidth: 2,
                                        fill: chartType === 'line',
                                        tension: 0.4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    plugins: {
                                        legend: {
                                            display: chartType !== 'line' && chartType !== 'bar',
                                            labels: { color: '#e0e0e0' }
                                        },
                                        title: {
                                            display: true,
                                            text: title,
                                            color: '#e0e0e0',
                                            font: { size: 16 }
                                        }
                                    },
                                    scales: (chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea') ? {} : {
                                        y: {
                                            beginAtZero: true,
                                            ticks: { color: '#e0e0e0' },
                                            grid: { color: '#444' }
                                        },
                                        x: {
                                            ticks: { color: '#e0e0e0' },
                                            grid: { color: '#444' }
                                        }
                                    }
                                }
                            };

                            try {
                                chartInstances[chartId] = new Chart(ctx, chartConfig);
                                writeToTerminal(`Chart: Rendered ${chartType} chart "${title}"`, 'log');
                            } catch (err) {
                                displayOutput(`Chart Error: ${err.message}`, true);
                            }
                        });

                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: Chart rendering failed: ${e.message}`, true);
                    }
                    continue;
                }

                // Media commands
                let matchMedia = line.match(/^get\.(img|audio|video)\s*\((.*)\)/);
                if (matchMedia) {
                    const mediaType = matchMedia[1];
                    const rawUrl = matchMedia[2].trim();
                    const url = interpolateString(rawUrl);

                    const mediaContainer = document.createElement('div');
                    mediaContainer.style.backgroundColor = 'var(--bg-tertiary)';
                    mediaContainer.style.border = '1px solid var(--border-color)';
                    mediaContainer.style.padding = '8px';
                    mediaContainer.style.borderRadius = '8px';
                    mediaContainer.style.margin = '8px 0';

                    let mediaElement;
                    if (mediaType === 'img') {
                        mediaElement = document.createElement('img');
                        mediaElement.src = url;
                        mediaElement.alt = 'Neote Media Image';
                        mediaElement.style.width = '100%';
                        mediaElement.style.height = 'auto';
                        mediaElement.style.borderRadius = '4px';
                        mediaElement.onerror = () => {
                            mediaElement.src = `https://placehold.co/300x150/505050/ffffff?text=Image+Load+Error`;
                            displayOutput(`[get.img] ERROR: Could not load image from ${url}`, true);
                        };
                        writeToTerminal(`Media: Loading image from ${url}`, 'log');
                    } else if (mediaType === 'audio') {
                        mediaElement = document.createElement('audio');
                        mediaElement.controls = true;
                        mediaElement.src = url;
                        mediaElement.style.width = '100%';
                        writeToTerminal(`Media: Loading audio from ${url}`, 'log');
                    } else if (mediaType === 'video') {
                        mediaElement = document.createElement('video');
                        mediaElement.controls = true;
                        mediaElement.src = url;
                        mediaElement.style.width = '100%';
                        mediaElement.style.height = 'auto';
                        mediaElement.style.borderRadius = '4px';
                        writeToTerminal(`Media: Loading video from ${url}`, 'log');
                    }
                    mediaContainer.appendChild(mediaElement);
                    outputPanel.appendChild(mediaContainer);
                    outputPanel.scrollTop = outputPanel.scrollHeight;
                    continue;
                }

                // Array operations (non-assignment)
                let matchArrayOp = line.match(/^(push|pop|shift|unshift|reverse|sort)\((.*)\)/);
                if (matchArrayOp) {
                    const arrayFunc = matchArrayOp[1];
                    const arrayArgs = matchArrayOp[2].trim();

                    if (!neoteArrayEnabled[arrayFunc]) {
                        displayOutput(`RUNTIME ERROR: Array function '${arrayFunc}' not imported. Add '$attach, @neoteArray take ${arrayFunc};'`, true);
                        continue;
                    }

                    try {
                        const args = arrayArgs.split(',').map(a => a.trim());
                        const arrName = args[0];

                        if (!neoteVariables[arrName] || !Array.isArray(neoteVariables[arrName])) {
                            displayOutput(`RUNTIME ERROR: '${arrName}' is not an array`, true);
                            continue;
                        }
                        if (arrayFunc === 'push') {
                            const value = args[1] ? (neoteVariables[args[1]] !== undefined ? neoteVariables[args[1]] : args[1]) : undefined;
                            neoteVariables[arrName].push(value);
                        } else if (arrayFunc === 'pop') {
                            neoteVariables[arrName].pop();
                        } else if (arrayFunc === 'shift') {
                            neoteVariables[arrName].shift();
                        } else if (arrayFunc === 'unshift') {
                            const value = args[1] ? (neoteVariables[args[1]] !== undefined ? neoteVariables[args[1]] : args[1]) : undefined;
                            neoteVariables[arrName].unshift(value);
                        } else if (arrayFunc === 'reverse') {
                            neoteVariables[arrName].reverse();
                        } else if (arrayFunc === 'sort') {
                            neoteVariables[arrName].sort();
                        }
                        updateVariableViewer();
                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: Array operation '${arrayFunc}' failed: ${e.message}`, true);
                    }
                    continue;
                }

                // Storage operations (non-assignment)
                let matchStorageOp = line.match(/^(save|remove|clearAll)\((.*)\)/);
                if (matchStorageOp) {
                    const storageFunc = matchStorageOp[1];
                    const storageArgs = matchStorageOp[2].trim();

                    if (!neoteStorageEnabled[storageFunc]) {
                        displayOutput(`RUNTIME ERROR: Storage function '${storageFunc}' not imported. Add '$attach, @neoteStorage take ${storageFunc};'`, true);
                        continue;
                    }

                    try {
                        if (storageFunc === 'save') {
                            const args = storageArgs.split(',').map(a => a.trim());
                            const key = args[0].replace(/^"|"$/g, '');
                            const value = args[1] ? (neoteVariables[args[1]] !== undefined ? neoteVariables[args[1]] : args[1].replace(/^"|"$/g, '')) : null;
                            localStorage.setItem(`neote_storage_${key}`, JSON.stringify(value));
                            writeToTerminal(`Storage: Saved '${key}'`, 'log');
                        } else if (storageFunc === 'remove') {
                            const key = storageArgs.replace(/^"|"$/g, '');
                            localStorage.removeItem(`neote_storage_${key}`);
                            writeToTerminal(`Storage: Removed '${key}'`, 'log');
                        } else if (storageFunc === 'clearAll') {
                            const keysToRemove = [];
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith('neote_storage_')) {
                                    keysToRemove.push(key);
                                }
                            }
                            keysToRemove.forEach(key => localStorage.removeItem(key));
                            writeToTerminal(`Storage: Cleared all storage`, 'log');
                        }
                    } catch (e) {
                        displayOutput(`RUNTIME ERROR: Storage operation '${storageFunc}' failed: ${e.message}`, true);
                    }
                    continue;
                }

                const trimmed = line.trim();
                if (trimmed.length > 0 && !trimmed.startsWith('$attach') && !trimmed.match(/^\$attach,\s*@neote/) && !trimmed.startsWith('//') && !trimmed.startsWith('/*') && !trimmed.startsWith('*/') && !trimmed.match(/^(st|showcase|call|func|macro|class|if|loop|each|button|input|get\.|ovr\.|chart\.|db\.|geo\.|regex\.|format\.|notify\.|dom\.|push|pop|save|remove|expand|checkbox|select|slider|textarea|progress|divider|heading|link|method|init|new\s)/)) {
                    writeToTerminal(`PARSER WARNING: Unrecognized line skipped: ${line}`, 'log');
                    const errorLog = document.createElement('div');
                    errorLog.className = 'text-warning font-mono text-xs mt-1 border-bottom border-warning pb-1';
                    errorLog.innerHTML = `<span class="font-bold">WARNING:</span> Unrecognized line: ${line}`;
                    problemsPanel.appendChild(errorLog);
                }
            }
        }

        function handleImprop(varName, rawValue) {
            const promptMatch = rawValue.match(/ovr\.improp\s*\((.*)\)/);
            if (promptMatch && promptMatch[1]) {
                const promptText = interpolateString(promptMatch[1]);

                modal.classList.remove('hidden');

                showPanel('output');
                showModal("Neote Input Required (ovr.improp)", promptText, true)
                    .then(result => {
                        neoteVariables[varName] = result;
                        updateVariableViewer();
                    });
            } else {
                displayOutput(`RUNTIME ERROR: Invalid ovr.improp syntax.`, true);
                isRunningImprop = false;
            }
        }

        function continueExecution() {
            if (executionIndex < executionQueue.length) {
                for (let i = executionIndex + 1; i < executionQueue.length; i++) {
                    const line = executionQueue[i];
                    executionIndex = i;

                    if (isRunningImprop) {
                        if (line.trim().match(/^st\s+([a-zA-Z0-9_]+)\s*=\s*ovr\.improp/)) {
                            handleImprop(line.match(/^st\s+([a-zA-Z0-9_]+)/)[1], line.match(/=\s*(.*)$/)[1]);
                            return;
                        }
                    }

                    executeLines([line]);
                }
            }
            isRunningImprop = false;
            writeToTerminal("Execution complete. Variables saved.", 'success');
        }

        function removeComments(code) {
            const lines = code.split('\n');
            const result = [];
            let inMultiLine = false;

            for (let line of lines) {
                let cleaned = '';
                let i = 0;

                while (i < line.length) {
                    if (!inMultiLine && line[i] === '/' && line[i + 1] === '*') {
                        inMultiLine = true;
                        i += 2;
                    } else if (inMultiLine && line[i] === '*' && line[i + 1] === '/') {
                        inMultiLine = false;
                        i += 2;
                    } else if (!inMultiLine && line[i] === '/' && line[i + 1] === '/') {
                        break;
                    } else if (!inMultiLine) {
                        cleaned += line[i];
                        i++;
                    } else {
                        i++;
                    }
                }

                if (!inMultiLine || cleaned.trim()) {
                    result.push(cleaned);
                }
            }

            return result.join('\n');
        }

        function runNeoteCode() {
            if (isRunningImprop) {
                displayOutput("SYSTEM MESSAGE: Cannot run code while awaiting input from 'ovr.improp'. Please complete the modal dialog.", true);
                return;
            }
            clearOutput();
            neoteVariables = {};
            neoteFunctions = {};
            neoteMacros = {};
            neoteClasses = {};
            updateVariableViewer();

            const code = codeEditor.value;
            const lines = code.split('\n');

            if (!lines[0].trim().startsWith('$attach, @neote;')) {
                displayOutput("EXECUTION STOPPED: Missing required header '$attach, @neote;' on the first line.", true);
                return;
            }

            // Check for module imports
            neoteMathEnabled = {};
            neoteArrayEnabled = {};
            neoteStorageEnabled = {};
            neoteChartEnabled = {};
            neoteDBEnabled = {};
            neoteGeoEnabled = {};
            neoteRegexEnabled = {};
            neoteFormatEnabled = {};
            neoteNotifyEnabled = {};
            neoteDOMEnabled = {};
            neoteHTTPEnabled = {};

            // Clear existing charts
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
            chartCounter = 0;

            for (let line of lines) {
                const mathImport = line.match(/^\$attach,\s*@neoteMath\s+take\s+(.+);/);
                if (mathImport) {
                    const imports = mathImport[1].trim();
                    if (imports === '*') {
                        neoteMathEnabled = { random: true, round: true, floor: true, ceil: true, abs: true, sqrt: true, pow: true, sin: true, cos: true, tan: true, min: true, max: true, log: true, exp: true, pi: true, e: true };
                        displayOutput(`[Neote Plus]: Imported all neoteMath modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteMathEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteMath: ${imports}`, false, true);
                    }
                }

                const arrayImport = line.match(/^\$attach,\s*@neoteArray\s+take\s+(.+);/);
                if (arrayImport) {
                    const imports = arrayImport[1].trim();
                    if (imports === '*') {
                        neoteArrayEnabled = { push: true, pop: true, shift: true, unshift: true, length: true, join: true, reverse: true, sort: true, includes: true, indexOf: true, slice: true };
                        displayOutput(`[Neote Plus]: Imported all neoteArray modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteArrayEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteArray: ${imports}`, false, true);
                    }
                }

                const storageImport = line.match(/^\$attach,\s*@neoteStorage\s+take\s+(.+);/);
                if (storageImport) {
                    const imports = storageImport[1].trim();
                    if (imports === '*') {
                        neoteStorageEnabled = { save: true, load: true, remove: true, clearAll: true, has: true, keys: true };
                        displayOutput(`[Neote Plus]: Imported all neoteStorage modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteStorageEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteStorage: ${imports}`, false, true);
                    }
                }

                const timeImport = line.match(/^\$attach,\s*@neoteTime\s+take\s+(.+);/);
                if (timeImport) {
                    const imports = timeImport[1].trim();
                    if (imports === '*') {
                        neoteTimeEnabled = { timestamp: true, getDate: true, getTime: true, getYear: true, getMonth: true, getDay: true, getHour: true, getMinute: true, getSecond: true, getDayName: true };
                        displayOutput(`[Neote Plus]: Imported all neoteTime modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteTimeEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteTime: ${imports}`, false, true);
                    }
                }

                const chartImport = line.match(/^\$attach,\s*@neoteChart\s+take\s+(.+);/);
                if (chartImport) {
                    const imports = chartImport[1].trim();
                    if (imports === '*') {
                        neoteChartEnabled = { bar: true, line: true, pie: true, doughnut: true, radar: true, polarArea: true };
                        displayOutput(`[Neote Plus]: Imported all neoteChart modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteChartEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteChart: ${imports}`, false, true);
                    }
                }

                const dbImport = line.match(/^\$attach,\s*@neoteDB\s+take\s+(.+);/);
                if (dbImport) {
                    const imports = dbImport[1].trim();
                    if (imports === '*') {
                        neoteDBEnabled = { create: true, insert: true, get: true, getAll: true, update: true, delete: true, query: true, drop: true, count: true, clear: true };
                        displayOutput(`[Neote Plus]: Imported all neoteDB modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteDBEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteDB: ${imports}`, false, true);
                    }
                }

                const geoImport = line.match(/^\$attach,\s*@neoteGeo\s+take\s+(.+);/);
                if (geoImport) {
                    const imports = geoImport[1].trim();
                    if (imports === '*') {
                        neoteGeoEnabled = { distance: true, getLocation: true, geocode: true };
                        displayOutput(`[Neote Plus]: Imported all neoteGeo modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteGeoEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteGeo: ${imports}`, false, true);
                    }
                }

                const regexImport = line.match(/^\$attach,\s*@neoteRegex\s+take\s+(.+);/);
                if (regexImport) {
                    const imports = regexImport[1].trim();
                    if (imports === '*') {
                        neoteRegexEnabled = { match: true, test: true, replace: true, split: true, extract: true };
                        displayOutput(`[Neote Plus]: Imported all neoteRegex modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteRegexEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteRegex: ${imports}`, false, true);
                    }
                }

                const formatImport = line.match(/^\$attach,\s*@neoteFormat\s+take\s+(.+);/);
                if (formatImport) {
                    const imports = formatImport[1].trim();
                    if (imports === '*') {
                        neoteFormatEnabled = { currency: true, number: true, date: true, fileSize: true, percentage: true, capitalize: true };
                        displayOutput(`[Neote Plus]: Imported all neoteFormat modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteFormatEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteFormat: ${imports}`, false, true);
                    }
                }

                const notifyImport = line.match(/^\$attach,\s*@neoteNotify\s+take\s+(.+);/);
                if (notifyImport) {
                    const imports = notifyImport[1].trim();
                    if (imports === '*') {
                        neoteNotifyEnabled = { success: true, error: true, warning: true, info: true };
                        displayOutput(`[Neote Plus]: Imported all neoteNotify modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteNotifyEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteNotify: ${imports}`, false, true);
                    }
                }

                const domImport = line.match(/^\$attach,\s*@neoteDOM\s+take\s+(.+);/);
                if (domImport) {
                    const imports = domImport[1].trim();
                    if (imports === '*') {
                        neoteDOMEnabled = { create: true, setText: true, setHTML: true, setStyle: true, addClass: true, removeClass: true, remove: true, show: true, hide: true };
                        displayOutput(`[Neote Plus]: Imported all neoteDOM modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteDOMEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteDOM: ${imports}`, false, true);
                    }
                }

                const httpImport = line.match(/^\$attach,\s*@neoteHTTP\s+take\s+(.+);/);
                if (httpImport) {
                    const imports = httpImport[1].trim();
                    if (imports === '*') {
                        neoteHTTPEnabled = { get: true, post: true, put: true, delete: true };
                        displayOutput(`[Neote Plus]: Imported all neoteHTTP modules.`, false, true);
                    } else {
                        imports.split(',').forEach(mod => {
                            const trimmed = mod.trim();
                            neoteHTTPEnabled[trimmed] = true;
                        });
                        displayOutput(`[Neote Plus]: Imported neoteHTTP: ${imports}`, false, true);
                    }
                }
            }

            neoteDOMElements = {};
            displayOutput(`[Neote Plus]: Interpreter starting...`, false, true);

            let funcName = null;
            let funcBody = [];
            let funcDepth = 0;
            let macroName = null;
            let macroParams = [];
            let macroBody = [];
            let inMacro = false;
            let className = null;
            let classBody = [];
            let classDepth = 0;

            for (let line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || trimmedLine.startsWith('//') || trimmedLine.startsWith('/*') || trimmedLine.startsWith('*/')) continue;

                let matchClassStart = trimmedLine.match(/^class\s+([a-zA-Z0-9_]+)\s*\{/);
                if (matchClassStart) {
                    if (classDepth === 0) {
                        className = matchClassStart[1].trim();
                        classBody = [];
                    }
                    classDepth++;
                    if (classDepth > 1) classBody.push(line);
                    continue;
                }

                if (classDepth > 0) {
                    if (trimmedLine === '}') {
                        classDepth--;
                        if (classDepth === 0) {
                            neoteClasses[className] = classBody.join('\n');
                            className = null;
                            classBody = [];
                        } else {
                            classBody.push(line);
                        }
                    } else {
                        classBody.push(line);
                    }
                    continue;
                }

                let matchMacroStart = trimmedLine.match(/^macro\s+([a-zA-Z0-9_]+)\s*\(([^)]*)\)\s*\{/);
                if (matchMacroStart) {
                    macroName = matchMacroStart[1].trim();
                    macroParams = matchMacroStart[2].split(',').map(p => p.trim()).filter(p => p);
                    macroBody = [];
                    inMacro = true;
                    continue;
                }

                if (inMacro) {
                    if (trimmedLine.includes('{')) macroBody.push(line);
                    else if (trimmedLine === '}') {
                        neoteMacros[macroName] = { params: macroParams, body: macroBody.join('\n') };
                        inMacro = false;
                        macroName = null;
                        macroParams = [];
                        macroBody = [];
                    } else {
                        macroBody.push(line);
                    }
                    continue;
                }

                let matchFuncStart = trimmedLine.match(/^func\s+([a-zA-Z0-9_]+)\s*\{/);
                if (matchFuncStart) {
                    if (funcDepth === 0) {
                        funcName = matchFuncStart[1].trim();
                        funcBody = [];
                    }
                    funcDepth++;
                    if (funcDepth > 1) funcBody.push(line);
                    continue;
                }

                if (funcDepth > 0) {
                    if (trimmedLine === '}') {
                        funcDepth--;
                        if (funcDepth === 0) {
                            neoteFunctions[funcName] = funcBody.join('\n');
                            funcName = null;
                            funcBody = [];
                        } else {
                            funcBody.push(line);
                        }
                    } else {
                        funcBody.push(line);
                    }
                }
            }

            if (funcDepth > 0) {
                displayOutput("PARSING ERROR: Function definition started but not closed with '}'.", true);
                return;
            }

            if (inMacro) {
                displayOutput("PARSING ERROR: Macro definition started but not closed with '}'.", true);
                return;
            }

            if (classDepth > 0) {
                displayOutput("PARSING ERROR: Class definition started but not closed with '}'.", true);
                return;
            }

            displayOutput(`[Neote Plus]: Found ${Object.keys(neoteFunctions).length} function(s), ${Object.keys(neoteMacros).length} macro(s), and ${Object.keys(neoteClasses).length} class(es). Starting main execution...`, false, true);

            try {
                const fullCode = removeComments(code);
                parseCodeBlock(fullCode);

                executeLines(executionQueue);

            } catch (e) {
                displayOutput(`CRITICAL RUNTIME ERROR: ${e.message}`, true);
            }
        }

        // Extension modal event listeners
        document.getElementById('extension-cancel').addEventListener('click', closeCreateExtensionModal);
        document.getElementById('extension-save').addEventListener('click', () => {
            const name = document.getElementById('extension-name').value.trim();
            const desc = document.getElementById('extension-desc').value.trim();
            const code = document.getElementById('extension-code').value.trim();

            if (!name) {
                alert('Extension name is required.');
                return;
            }
            if (!code) {
                alert('Extension code is required.');
                return;
            }

            extensionAPI.register(name, desc || 'No description provided', code);
            displayOutput(`Extension '${name}' created successfully!`, false);
            closeCreateExtensionModal();
        });

        document.getElementById('extension-view-close').addEventListener('click', closeExtensionViewModal);
        document.getElementById('extension-view-delete').addEventListener('click', () => {
            const id = document.getElementById('extension-view-modal').dataset.extensionId;
            if (id) {
                deleteExtension(id);
            }
        });

        // Initialize example extensions if none exist
        function initializeExampleExtensions() {
            if (Object.keys(neoteExtensions).length === 0) {
                extensionAPI.register(
                    'Greeting',
                    'Displays a welcome message',
                    `showcase("====== Welcome to Extensions! ======")
showcase("This extension demonstrates how to use Neote Extensions.")
showcase("You can create your own extensions from the Extensions panel!")
divider()`
                );

                extensionAPI.register(
                    'SimpleCalculator',
                    'Performs basic arithmetic operations',
                    `st num1 = 10
st num2 = 5
st sum = num1 + num2
st diff = num1 - num2
st product = num1 * num2
st division = num1 / num2
showcase("=== Simple Calculator ===")
showcase("$num1 + $num2 = $sum")
showcase("$num1 - $num2 = $diff")
showcase("$num1 √ó $num2 = $product")
showcase("$num1 √∑ $num2 = $division")`
                );

                extensionAPI.register(
                    'DataDisplay',
                    'Shows data manipulation example',
                    `st colors = ["Red", "Green", "Blue", "Yellow"]
st numbers = [1, 2, 3, 4, 5]
showcase("=== Data Display Extension ===")
showcase("Colors in our list:")
each colors as color {
  showcase("  ‚Ä¢ $color")
}
showcase("Numbers: $numbers")`
                );

                extensionAPI.register(
                    'InfoBanner',
                    'Shows system information',
                    `heading("System Information", 2)
divider("Details")
showcase("Neote Version: 4.1.8")
showcase("Extensions Enabled: Yes")
showcase("Database Support: Yes")
showcase("Charts Support: Yes")
divider()`
                );

                extensionAPI.register(
                    'InteractiveDemo',
                    'Shows interactive UI elements',
                    `showcase("=== Interactive Demo ===")
divider()
input("user_name", "Enter your name")
input("user_age", "Enter your age")
button("Click Me!", demoFunc)
divider()`
                );
            }
        }

        // Home page navigation
        function showHome() {
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('ide-main').style.display = 'none';
            document.getElementById('header-title').textContent = 'Neote IDE - Home';
        }

        function showIDE() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('ide-main').style.display = 'flex';
            document.getElementById('header-title').textContent = `Neote IDE - ${currentFile}`;
        }

        function startNewFile() {
            createNewFile();
            showIDE();
        }

        // Initial setup on load
        window.onload = () => {
            loadExtensions();
            initializeExampleExtensions();
            renderExtensionsList();
            renderFileTabs();
            renderFileExplorer();
            updateLineNumbers(codeEditor.value);
            syncScroll();
            showPanel('output');
            initResizing();
            showHome();

            // Initialize Lucide icons
            lucide.createIcons();
        };
        (function () {
            // Configuration - Put your image link here, Warren.
            const imgSrc = './neote logo.png';

            const style = document.createElement('style');
            style.innerHTML = `
        #epsilon-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        #epsilon-overlay img {
            max-width: 100%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            100% { transform: scale(0.95); }
        }
        .epsilon-fade-out {
            opacity: 0;
            pointer-events: none;
        }
    `;
            document.head.appendChild(style);

            const loader = document.createElement('div');
            loader.id = 'epsilon-overlay';
            loader.innerHTML = `<img src="${imgSrc}" alt="Loading...">`;
            document.body.prepend(loader);

            window.addEventListener('load', () => {
                setTimeout(() => {
                    loader.classList.add('epsilon-fade-out');
                    // Remove from DOM after fade for performance
                    setTimeout(() => loader.remove(), 500);
                }, 300); // Small delay so it's not a jump-scare
            });
        })();
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/sw.js");
            });
        }
    </script>
</body>

</html>
